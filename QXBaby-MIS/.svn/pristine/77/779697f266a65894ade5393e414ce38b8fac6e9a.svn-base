package com.onlineMIS.ORM.DAO.chainS.report;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.naming.java.javaURLContextFactory;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.ProjectionList;
import org.hibernate.criterion.Projections;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.onlineMIS.ORM.DAO.Response;
import com.onlineMIS.ORM.DAO.chainS.inventoryFlow.ChainInOutStockDaoImpl;
import com.onlineMIS.ORM.DAO.chainS.sales.ChainStoreSalesOrderDaoImpl;
import com.onlineMIS.ORM.DAO.chainS.user.ChainStoreDaoImpl;
import com.onlineMIS.ORM.DAO.chainS.user.ChainStoreService;
import com.onlineMIS.ORM.DAO.chainS.user.ChainUserInforDaoImpl;
import com.onlineMIS.ORM.DAO.chainS.user.ChainUserInforService;
import com.onlineMIS.ORM.DAO.headQ.barCodeGentor.BrandDaoImpl;
import com.onlineMIS.ORM.DAO.headQ.barCodeGentor.ProductBarcodeDaoImpl;
import com.onlineMIS.ORM.DAO.headQ.barCodeGentor.ProductDaoImpl;
import com.onlineMIS.ORM.DAO.headQ.barCodeGentor.QuarterDaoImpl;
import com.onlineMIS.ORM.DAO.headQ.barCodeGentor.YearDaoImpl;
import com.onlineMIS.ORM.DAO.headQ.finance.ChainFinanceTraceImpl;
import com.onlineMIS.ORM.DAO.headQ.finance.FinanceCategoryImpl;
import com.onlineMIS.ORM.DAO.headQ.inventory.InventoryOrderDAOImpl;
import com.onlineMIS.ORM.DAO.headQ.inventory.InventoryOrderProductDAOImpl;
import com.onlineMIS.ORM.entity.base.Pager;
import com.onlineMIS.ORM.entity.chainS.inventoryFlow.ChainInOutStock;
import com.onlineMIS.ORM.entity.chainS.inventoryFlow.ChainInventoryReportTemplate;
import com.onlineMIS.ORM.entity.chainS.inventoryFlow.ChainLevelFourInventoryItem;
import com.onlineMIS.ORM.entity.chainS.report.ChainAllInOneReportItemLevelFour;
import com.onlineMIS.ORM.entity.chainS.report.ChainAllInOneReportItemLevelOne;
import com.onlineMIS.ORM.entity.chainS.report.ChainAllInOneReportItemLevelThree;
import com.onlineMIS.ORM.entity.chainS.report.ChainAllInOneReportItemLevelTwo;
import com.onlineMIS.ORM.entity.chainS.report.ChainDailySalesAnalysis;
import com.onlineMIS.ORM.entity.chainS.report.ChainFinanceReport;
import com.onlineMIS.ORM.entity.chainS.report.ChainFinanceReportItem;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseReport;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseStatisReportItem;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseStatisReportItemLevelFour;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseStatisReportItemLevelOne;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseStatisReportItemLevelThree;
import com.onlineMIS.ORM.entity.chainS.report.ChainPurchaseStatisReportItemLevelTwo;
import com.onlineMIS.ORM.entity.chainS.report.ChainReport;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesReport;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesReportTemplate;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisReportItem;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisReportItemLevelFour;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisReportItemLevelOne;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisReportItemLevelThree;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisReportItemLevelTwo;
import com.onlineMIS.ORM.entity.chainS.report.ChainSalesStatisticsReportTemplate;
import com.onlineMIS.ORM.entity.chainS.report.ChainWMRank;
import com.onlineMIS.ORM.entity.chainS.report.ChainWMRankItem;
import com.onlineMIS.ORM.entity.chainS.report.ChainWeeklySales;
import com.onlineMIS.ORM.entity.chainS.sales.ChainStoreSalesOrder;
import com.onlineMIS.ORM.entity.chainS.sales.PurchaseOrderTemplate;
import com.onlineMIS.ORM.entity.chainS.user.ChainRoleType;
import com.onlineMIS.ORM.entity.chainS.user.ChainStore;
import com.onlineMIS.ORM.entity.chainS.user.ChainUserInfor;
import com.onlineMIS.ORM.entity.headQ.barcodeGentor.Brand;
import com.onlineMIS.ORM.entity.headQ.barcodeGentor.Product;
import com.onlineMIS.ORM.entity.headQ.barcodeGentor.ProductBarcode;
import com.onlineMIS.ORM.entity.headQ.barcodeGentor.Quarter;
import com.onlineMIS.ORM.entity.headQ.barcodeGentor.Year;
import com.onlineMIS.ORM.entity.headQ.finance.FinanceCategory;
import com.onlineMIS.ORM.entity.headQ.inventory.InventoryOrder;
import com.onlineMIS.action.chainS.report.ChainReportActionFormBean;
import com.onlineMIS.action.chainS.report.ChainReportActionUIBean;
import com.onlineMIS.common.Common_util;
import com.onlineMIS.common.ExcelUtil;
import com.onlineMIS.common.loggerLocal;
import com.onlineMIS.sorter.ChainInventoryReportSort;

@Service
public class ChainReportService {
	@Autowired
	private ChainStoreService chainStoreService;
	
	@Autowired
	private ChainInOutStockDaoImpl chainInOutStockDaoImpl;
	
	@Autowired
	private ChainStoreSalesOrderDaoImpl chainSalesOrderDaoImpl;
	
	@Autowired
	private InventoryOrderDAOImpl inventoryOrderDAOImpl;
	
	@Autowired
	private InventoryOrderProductDAOImpl inventoryOrderProductDAOImpl;
	
	@Autowired
	private ChainFinanceTraceImpl chainFinanceTraceImpl;
	
	@Autowired
	private FinanceCategoryImpl financeCategoryImpl;
	
	@Autowired
	private ChainUserInforDaoImpl chainUserInforDaoImpl;
	
	@Autowired
	private YearDaoImpl yearDaoImpl;
	
	@Autowired
	private ChainStoreDaoImpl chainStoreDaoImpl;
	
	@Autowired
	private QuarterDaoImpl quarterDaoImpl;
	
	@Autowired
	private BrandDaoImpl brandDaoImpl;
	
	@Autowired
	private ProductBarcodeDaoImpl productBarcodeDaoImpl;
	
	@Autowired
	private ChainWeeklySalesDaoImpl chainWeeklySalesDaoImpl;
	
	@Autowired
	private ProductDaoImpl productDaoImpl;
	
	/**
	 * to prepare the generate the report UI
	 * @param uiBean
	 * @param loginUser
	 */
	public void prepareGenReportUI(ChainReportActionUIBean uiBean, ChainUserInfor loginUser){
		uiBean.setChainStores(chainStoreService.getChainStoreList(loginUser));
		
	}
	
	/**
	 * 准备按照员工分类的销售报表
	 * @param formBean
	 * @param uiBean
	 * @param userInfor
	 */
	public void prepareGenSalesReportBySalerUI(
			ChainReportActionFormBean formBean, ChainReportActionUIBean uiBean,
			ChainUserInfor loginUser) {
		uiBean.setChainStores(chainStoreService.getChainStoreList(loginUser));
		
		if (!ChainUserInforService.isMgmtFromHQ(loginUser)){
			ChainStore chainStore = chainStoreService.getChainStoreByID(loginUser.getMyChainStore().getChain_id());
			formBean.setChainStore(chainStore);
		}
	}

	/**
	 * to generate the report
	 * @param formBean
	 */
	public Response generateChainReport(ChainReportActionFormBean formBean) {
		Response response = new Response();
		
		int chainId = formBean.getChainStore().getChain_id();
		int salerId = formBean.getSaler().getUser_id();
		Date startDate = Common_util.formStartDate(formBean.getStartDate());
		Date endDate = Common_util.formEndDate(formBean.getEndDate());
		int reportType = formBean.getReportType();
		
		ChainReport report = new ChainReport();
		report.setChainStore(formBean.getChainStore());
		
		/**
		 * 销售报表, 采购报表，财务报表
		 * type 1 : 直接表达出来，比如只求某个连锁店
		 *      2   ： 求销售的总数
		 */
		if (reportType == ChainReport.TYPE_SALES_REPORT){
			Object[] value_sale = new Object[]{startDate, endDate, ChainStoreSalesOrder.STATUS_COMPLETE};
			ChainSalesReport salesReport = generateSalesTotal(chainId, salerId, value_sale);
			response.setReturnValue(salesReport);
			response.setAction(1);
		} else if (reportType == ChainReport.TYPE_PURCHASE_REPORT){
			int clientId = chainStoreService.getChainStoreByID(chainId).getClient_id();
			report = generatePurchaseReport(clientId, startDate, endDate);
			response.setReturnValue(report);
			response.setAction(1);
		} else if (reportType == ChainReport.TYPE_FINANCE_REPORT){
			report = generateFinanceReport(chainId, startDate, endDate);
			response.setReturnValue(report);
			response.setAction(1);
		}
		
		return response;
	}

	/**
	 * to generate the 财务报表
	 * @param chainId
	 * @param startDate
	 * @param endDate
	 * @return
	 */
	private ChainReport generateFinanceReport(int chainId, Date startDate,
			Date endDate) {
		Object[] values = new Object[]{chainId, startDate, endDate};
		String hql = "select categoryId, sum(amount) from ChainFinanceTrace where chainId =? and date between ? and ? group by categoryId";
		List<ChainFinanceReportItem> reportItems = new ArrayList<ChainFinanceReportItem>();
		
		List<Object> reportObj =  chainFinanceTraceImpl.executeHQLSelect(hql, values,null, false);
		if (reportObj != null){
			Map<Integer, FinanceCategory> categoryMap = financeCategoryImpl.getFinanceCategoryMap();
			
			for (Object reportItemObj: reportObj){
				Object[] reportItemObjArray = (Object[])reportItemObj;
				int typeId = Common_util.getInt(reportItemObjArray[0]);
				double amount = Common_util.getDouble(reportItemObjArray[1]);
				
				FinanceCategory category = categoryMap.get(typeId);
				if (category != null){
					ChainFinanceReportItem reportItem = new ChainFinanceReportItem(category, amount);
					reportItems.add(reportItem);
				}
			}
		}
		
		ChainFinanceReport financeReport = new ChainFinanceReport();
		financeReport.setReportItems(reportItems);
		financeReport.setType(ChainReport.TYPE_FINANCE_REPORT);
		
		return financeReport;
	}

	/**
	 * to generate the purchase report 采购报表
	 * @param clientId
	 * @param startDate
	 * @param endDate
	 * @return
	 */
	private ChainReport generatePurchaseReport(int clientId, Date startDate,
			Date endDate) {
		Object[] valuesPurchase = new Object[]{startDate, endDate, InventoryOrder.STATUS_ACCOUNT_COMPLETE,clientId, InventoryOrder.TYPE_SALES_ORDER_W};
		Object[] valuesReturn = new Object[]{startDate, endDate, InventoryOrder.STATUS_ACCOUNT_COMPLETE,clientId, InventoryOrder.TYPE_SALES_RETURN_ORDER_W};
		
		String hql_purchase = "select sum(totalQuantity), sum(totalWholePrice) from InventoryOrder where order_EndTime between ? and ? and order_Status = ? and client_id=? and order_type =?";
		String hql_return = "select sum(totalQuantity), sum(totalWholePrice) from InventoryOrder where order_EndTime between ? and ? and order_Status = ? and client_id=? and order_type =?";
		
		Object[] purchase =  (Object[])inventoryOrderDAOImpl.executeHQLSelect(hql_purchase, valuesPurchase,null, false).get(0);
		Object[] returns = (Object[])inventoryOrderDAOImpl.executeHQLSelect(hql_return, valuesReturn,null, false).get(0);
		
		int purchaseQ = Common_util.getInt(purchase[0]);
		int returnQ = Common_util.getInt(returns[0]);
		double purchaseP = Common_util.getDouble(purchase[1]);
		double returnP = Common_util.getDouble(returns[1]);
		
		ChainPurchaseReport purchaseReport = new ChainPurchaseReport(ChainReport.TYPE_PURCHASE_REPORT, purchaseQ, returnQ, purchaseP, returnP);

		return purchaseReport;
	}
	
	/**
	 * 连锁店总部获取信息
	 * @param formBean
	 * @return
	 */
	public Response generateSalesReport(ChainReportActionFormBean formBean, Integer page, Integer rowPerPage, String sortName, String sortOrder) {
		Response response = new Response();
		
		int chainId = formBean.getChainStore().getChain_id();
		Date startDate = Common_util.formStartDate(formBean.getStartDate());
		Date endDate = Common_util.formEndDate(formBean.getEndDate());
		int salerId = Common_util.ALL_RECORD;
		
		ChainReport report = new ChainReport();
		report.setChainStore(formBean.getChainStore());
		
		Map data = new HashMap<String, Object>();
		
		try {
			generateSalesReportByHQ(data, chainId, salerId, startDate, endDate, page, rowPerPage, sortName, sortOrder);
			response.setReturnCode(Response.SUCCESS);
		} catch (Exception e) {
			response.setReturnCode(Response.FAIL);
		}
		response.setReturnValue(data);
		
		return response;
	}
	
	/**
	 * 获取sales report的总数,或者连锁店获取自己的总数
	 * @param chainId
	 * @param salerId
	 * @param startDate
	 * @param endDate
	 * @return
	 */
	private ChainSalesReport generateSalesTotal(int chainId, int salerId, Object[] value_sale){
		/**1. to get the information from the sales order and exchange order
		 * 收入, 销售额， 销售总量，退货额，退货总量,,
		 */
		String chainCriteria = "";
		if (chainId == Common_util.ALL_RECORD)
			chainCriteria = " chainStore.chain_id <> " + ChainStore.CHAIN_ID_TEST_ID;
		else 
			chainCriteria = " chainStore.chain_id = " + chainId;
		
		if (salerId != Common_util.ALL_RECORD)
			chainCriteria += " AND saler.user_id = " + salerId;

		String hql_sale = "select sum(totalQuantity), sum(netAmount),  sum(totalQuantityR), " +
				"sum(netAmountR), sum(totalCost), sum(totalQuantityF) ,sum(totalCostF), sum(discountAmount), " +
				"sum(coupon), sum (cardAmount), sum(cashAmount - returnAmount), sum(vipScore), sum(totalAmount - netAmount), sum(qxQuantity), sum(qxAmount), sum(qxCost), sum(myQuantity), sum(myAmount), sum(myCost) from ChainStoreSalesOrder where orderDate between ? and ? and status = ? and " + chainCriteria;

		Object[] sales = (Object[])chainSalesOrderDaoImpl.executeHQLSelect(hql_sale, value_sale,null, true).get(0);

		int totalQ = Common_util.getInt(sales[0]);
		double netAmt = Common_util.getDouble(sales[1]);
		int totalQR = Common_util.getInt(sales[2]);
		double netAmtR = Common_util.getDouble(sales[3]);
		double totalCost = Common_util.getDouble(sales[4]);
		int totalQF = Common_util.getInt(sales[5]);
		double totalCostF = Common_util.getDouble(sales[6]);
		double discountAmt = Common_util.getDouble(sales[7]);
		double coupon = Common_util.getDouble(sales[8]);
		double cardAmt = Common_util.getDouble(sales[9]);
		double cashAmt = Common_util.getDouble(sales[10]);
		double vipScoreAmt = Common_util.getDouble(sales[11]);
		double totalSalesDiscountAmt = Common_util.getDouble(sales[12]);
		int qxQuantity = Common_util.getInt(sales[13]);
		double qxAmount = Common_util.getDouble(sales[14]);
		double qxCost = Common_util.getDouble(sales[15]);
		int myQuantity = Common_util.getInt(sales[16]);
		double myAmount = Common_util.getDouble(sales[17]);
		double myCost = Common_util.getDouble(sales[18]);
		
		ChainStore chainStore = new ChainStore();
		chainStore.setChain_id(chainId);
		ChainSalesReport chainReport = new ChainSalesReport(ChainReport.TYPE_SALES_REPORT, totalQ, totalQR,
				totalQF, netAmt,totalSalesDiscountAmt, netAmtR,totalCost, totalCostF, discountAmt,
				coupon, cardAmt, cashAmt, vipScoreAmt, qxQuantity,qxAmount, qxCost, myQuantity, myAmount, myCost);
		chainReport.setChainStore(chainStore);
		
		return chainReport;
	}
	
	/**
	 * 计算sale report 分页
	 * @param chainId
	 * @param salerId
	 * @param startDate
	 * @param endDate
	 * @param pager
	 */
	private int calculateSaleReportCount(int chainId, Object[] value_sale){
		//2.1 计算pager
		String criteria = "";
		if (chainId == Common_util.ALL_RECORD)
			criteria = " FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ?";
		else 
			criteria = "FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ? AND chainStore.chain_id = " + chainId;

		String criteria2 = "SELECT COUNT(DISTINCT chainStore.chain_id) " + criteria;
		    
	    return chainSalesOrderDaoImpl.executeHQLCount(criteria2, value_sale, true);
	}


	/**
	 * to generate the sales report 销售报表
	 * @param chainId
	 * @param startDate
	 * @param endDate
	 * @return
	 */
	private void generateSalesReportByHQ(Map saleReport, int chainId, int salerId, Date startDate,
			Date endDate, Integer page, Integer rowPerPage, String sortName, String sortOrder) {
		/**
		 * 1. 获取total
		 */
		Object[] value_sale = new Object[]{startDate, endDate, ChainStoreSalesOrder.STATUS_COMPLETE};
		ChainSalesReport totalReport = generateSalesTotal(chainId, salerId, value_sale);
		
		/**
		 * 2. 实现分页,如果是搜索所有连锁店
		 */
		int total = 0;
		if (page != null && rowPerPage != null)
			total = calculateSaleReportCount(chainId, value_sale);
		
		/**
		 * 获取数据列表
		 */
		List<ChainSalesReport> reports = new ArrayList<ChainSalesReport>();
		String criteria = "";
		if (chainId == Common_util.ALL_RECORD)
			criteria = " FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ?";
		else 
			criteria = "FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ? AND chainStore.chain_id = " + chainId;

		criteria += " GROUP BY chainStore.chain_id ";
		
		String orderBy = generateSalesOrderBy(sortName, sortOrder);
		
		criteria += orderBy;
		
		String hql_sale2 = "SELECT sum(totalQuantity), sum(netAmount), sum(totalQuantityR), " +
				"sum(netAmountR), sum(totalCost), sum(totalQuantityF) ,sum(totalCostF), sum(discountAmount), " +
				"sum(coupon), sum (cardAmount), sum(cashAmount - returnAmount), sum(vipScore), chainStore.chain_id, sum(totalAmount - netAmount), sum(qxQuantity), sum(qxAmount), sum(qxCost), sum(myQuantity), sum(myAmount), sum(myCost)  " + criteria;

		Integer[] pagerArray = null;
		if (page != null && rowPerPage != null)
		      pagerArray = new Integer[]{Common_util.getFirstRecord(page, rowPerPage), rowPerPage};
		
		List<Object> sales2 = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale2, value_sale,pagerArray, true);

		for (Object resultObject : sales2){
			Object[] sales3 = (Object[])resultObject;
			int totalQ2 = Common_util.getInt(sales3[0]);
			double netAmt2 = Common_util.getDouble(sales3[1]);
			int totalQR2 = Common_util.getInt(sales3[2]);
			double netAmtR2 = Common_util.getDouble(sales3[3]);
			double totalCost2 = Common_util.getDouble(sales3[4]);
			int totalQF2 = Common_util.getInt(sales3[5]);
			double totalCostF2 = Common_util.getDouble(sales3[6]);
			double discountAmt2 = Common_util.getDouble(sales3[7]);
			double coupon2 = Common_util.getDouble(sales3[8]);
			double cardAmt2 = Common_util.getDouble(sales3[9]);
			double cashAmt2 = Common_util.getDouble(sales3[10]);
			double vipScoreAmt2 = Common_util.getDouble(sales3[11]);
			int chainStoreId =  Common_util.getInt(sales3[12]);
			double totalSalesDiscountAmt2 = Common_util.getDouble(sales3[13]);
			int qxQuantity = Common_util.getInt(sales3[14]);
			double qxAmount = Common_util.getDouble(sales3[15]);
			double qxCost = Common_util.getDouble(sales3[16]);
			int myQuantity = Common_util.getInt(sales3[17]);
			double myAmount = Common_util.getDouble(sales3[18]);
			double myCost = Common_util.getDouble(sales3[19]);
			
			ChainStore store = chainStoreDaoImpl.get(chainStoreId, true);
			
			ChainSalesReport chainReport2 = new ChainSalesReport(ChainReport.TYPE_SALES_REPORT, totalQ2, totalQR2,
					totalQF2, netAmt2,totalSalesDiscountAmt2, netAmtR2,totalCost2, totalCostF2, discountAmt2,
					coupon2, cardAmt2, cashAmt2, vipScoreAmt2, qxQuantity,qxAmount, qxCost, myQuantity, myAmount, myCost, store);
			reports.add(chainReport2);
		}

		List<ChainSalesReport> footer = new ArrayList<ChainSalesReport>();
		footer.add(totalReport);
		saleReport.put("footer", footer);
		saleReport.put("rows", reports);
		saleReport.put("total", total);
	}
	
	/**
	 * 生成销售分析报表
	 * @param formBean
	 * @param page
	 * @param rows
	 * @param sort
	 * @param order
	 * @return
	 */
	public Response generateSalesAnalysisReport(
			ChainReportActionFormBean formBean, int page, int rows,
			String sort, String order,ChainUserInfor userInfor) {
		Response response = new Response();
		/**
		 * 如果是非连锁店经理，只能在6点以后查询
		 */
//		if (!ChainUserInforService.isMgmtFromHQ(userInfor)){
//			Date currentDate = new Date();
//            int hr = currentDate.getHours();
//			if (hr < 18 && hr >9){
//				response.setReturnCode(Response.FAIL);
//				response.setMessage("因为数据收集和计算等原因，普通用户只能在晚上六点以后使用此功能");
//				return response;
//			}
//		}
//		
		
		int chainId = formBean.getChainStore().getChain_id();
		Date startDate = Common_util.formStartDate(formBean.getStartDate());
		Date endDate = Common_util.formEndDate(formBean.getEndDate());
		
		/**
		 * 1. 获取连锁店total
		 */
		Object[] value_sale = new Object[]{startDate, endDate, ChainStoreSalesOrder.STATUS_COMPLETE};
		ChainDailySalesAnalysis totalReport = generateSalesAnalysisTotal(chainId, value_sale);
		
		
		List<ChainDailySalesAnalysis> footer = new ArrayList<ChainDailySalesAnalysis>();
		footer.add(totalReport);
		
		List<ChainDailySalesAnalysis> reports = generateSalesAnalysis(chainId, value_sale);
		
		Map saleReport = new HashMap();
		saleReport.put("footer", footer);
		saleReport.put("rows", reports);
		saleReport.put("total", new Integer(1));
		
		
		
		response.setReturnValue(saleReport);
		response.setReturnCode(Response.SUCCESS);
		return response;
	}

	/**
	 * 生成连锁店销售分析报表的总计
	 * @param chainId
	 * @param value_sale
	 * @return
	 */
	private ChainDailySalesAnalysis generateSalesAnalysisTotal(int chainId,
			Object[] value_sale) {
		String chainCriteria = "";
		//1. 创建parameters
		String chainOneQuantityCritiera = "";
		chainOneQuantityCritiera = " chainStore.chain_id <> " + ChainStore.CHAIN_ID_TEST_ID + " AND totalQuantityA = 1 ";
		chainCriteria = " chainStore.chain_id <> " + ChainStore.CHAIN_ID_TEST_ID + " AND totalQuantityA > 0 AND totalQuantityA < " + Common_util.SALES_ANALYSIS_BAD_ORDER;

		String hql_sale_analysis = "select avg(totalQuantityA), max(totalQuantityA),  sum(netAmountA)/sum(totalQuantityA), count(id), chainStore.chain_id from ChainStoreSalesOrder where orderDate between ? and ? and status = ? and " + chainCriteria;
		String hql_sale_analysis_one = "select count(id), chainStore.chain_id from ChainStoreSalesOrder where orderDate between ? and ? and status = ? and " + chainOneQuantityCritiera;
		
		//2. 第一轮select
		List<Object> salesAnalysis = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale_analysis, value_sale,null, true);

		ChainStore store = ChainStoreDaoImpl.getAllChainStoreObject();
		store.setChain_name("所有店平均水平");
		ChainDailySalesAnalysis dailySalesAnalysis = new ChainDailySalesAnalysis(store, null);
		
		for (Object resultObject : salesAnalysis){
			Object[] sales = (Object[])resultObject;
			double liandai = Common_util.getDouble(sales[0]);
			int largestSalesQ = Common_util.getInt(sales[1]);		
			double kedan = Common_util.getDouble(sales[2]);
			int countArray = Common_util.getInt(sales[3]);
			
			if (countArray < Common_util.SALES_ANALYSIS_BAD_STORE)
				continue;

			dailySalesAnalysis.setKeDanAvg(kedan);
			dailySalesAnalysis.setLargestSalesQ(largestSalesQ);
			dailySalesAnalysis.setLianDaiRatio(liandai);
			
			//3. 第二轮select
			List<Object> salesAnalysis2 = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale_analysis_one, value_sale,null, true);
			for (Object resultObject2 : salesAnalysis2){
				Object[] sales2 = (Object[])resultObject2;
				int oneQCountArray = Common_util.getInt(sales2[0]);

				if (countArray != 0)
				    dailySalesAnalysis.setKeChiOrderRatio((double)oneQCountArray/countArray);
			}
		}
		
		return dailySalesAnalysis;
	}
	
	private List<ChainDailySalesAnalysis> generateSalesAnalysis(int chainId, Object[] value_sale){
		String chainCriteria = "";
		//单件量
		String chainOneQuantityCritiera = "";
		if (chainId == Common_util.ALL_RECORD){
			chainOneQuantityCritiera = " chainStore.chain_id <> " + ChainStore.CHAIN_ID_TEST_ID + " AND totalQuantityA = 1  GROUP BY chainStore.chain_id ";
			chainCriteria = " chainStore.chain_id <> " + ChainStore.CHAIN_ID_TEST_ID + " AND  totalQuantityA > 0  AND totalQuantityA < " + Common_util.SALES_ANALYSIS_BAD_ORDER +" GROUP BY chainStore.chain_id ORDER BY avg(totalQuantityA) DESC";
		} else {
			chainOneQuantityCritiera = " chainStore.chain_id = " + chainId + " AND totalQuantityA = 1";
			chainCriteria = " chainStore.chain_id = " + chainId + " AND totalQuantityA > 0  AND totalQuantityA < " + Common_util.SALES_ANALYSIS_BAD_ORDER;
		}
		

		String hql_sale_analysis = "select avg(totalQuantityA), max(totalQuantityA),  sum(netAmountA)/sum(totalQuantityA) , count(id), chainStore.chain_id from ChainStoreSalesOrder  where orderDate between ? and ? and status = ? and " + chainCriteria;
		String hql_sale_analysis_one = "select count(id), chainStore.chain_id from ChainStoreSalesOrder where orderDate between ? and ? and status = ? and " + chainOneQuantityCritiera;
		
		/**
		 * 1. 生成除开可耻率的数据
		 */
		List<Object> salesAnalysis = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale_analysis, value_sale,null, true);

		
		Map<Integer, ChainDailySalesAnalysis> salesAnalysisMap = new HashMap<Integer, ChainDailySalesAnalysis>();
		Map<Integer, Integer> orderNumMap= new HashMap<Integer, Integer>();
		int rank = 0;

		for (Object resultObject : salesAnalysis){
			rank++;
			Object[] sales = (Object[])resultObject;
			

			double liandai = Common_util.getDouble(sales[0]);
			int largestSalesQ = Common_util.getInt(sales[1]);		
			double kedan = Common_util.getDouble(sales[2]);
			int countArray = Common_util.getInt(sales[3]);
			int chainIdArray = Common_util.getInt(sales[4]);
			
			if (countArray < Common_util.SALES_ANALYSIS_BAD_STORE)
				continue;
			
			ChainStore store = chainStoreDaoImpl.get(chainIdArray, true);
			ChainDailySalesAnalysis dailySalesAnalysis = new ChainDailySalesAnalysis(store, null);
			

			dailySalesAnalysis.setKeDanAvg(kedan);
			dailySalesAnalysis.setLargestSalesQ(largestSalesQ);
			dailySalesAnalysis.setLianDaiRatio(liandai);
			dailySalesAnalysis.setRank(rank);
			dailySalesAnalysis.setKeChiOrderRatio(0);

			salesAnalysisMap.put(chainIdArray, dailySalesAnalysis);
			
			orderNumMap.put(chainIdArray, countArray);
		}
		
		/**
		 * 2. 生成可耻率数据
		 */
		List<Object> salesAnalysis2 = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale_analysis_one, value_sale,null, true);
		for (Object resultObject2 : salesAnalysis2){
			Object[] sales2 = (Object[])resultObject2;
			int oneQCountArray = Common_util.getInt(sales2[0]);
			int chainIdArray = Common_util.getInt(sales2[1]);

			ChainDailySalesAnalysis chainDailySalesAnalysis = salesAnalysisMap.get(chainIdArray);
			if (chainDailySalesAnalysis != null){
				int countArray = orderNumMap.get(chainIdArray);
				if (countArray != 0){
					chainDailySalesAnalysis.setKeChiOrderRatio((double)oneQCountArray/countArray);
					salesAnalysisMap.put(chainIdArray, chainDailySalesAnalysis);
				}
			}
		}
		
		List<ChainDailySalesAnalysis> salesAnalysises = new ArrayList<ChainDailySalesAnalysis>(salesAnalysisMap.values());
		
		Collections.sort(salesAnalysises, new Comparator<ChainDailySalesAnalysis>() {
			@Override
			public int compare(ChainDailySalesAnalysis arg0,
					ChainDailySalesAnalysis arg1) {
				return arg0.getRank() - arg1.getRank();
			}	
		});
		
		return salesAnalysises;
	}

	/**
	 * 创建order by
	 * @param sortName
	 * @param sortOrder
	 * @return
	 */
	private String generateSalesOrderBy(String sortName, String sortOrder) {
		String orderBy = " ORDER BY sum(netAmount - netAmountR) desc";
		if (sortName != null && sortOrder != null){
			if (sortName.equals("saleQuantitySum"))
				orderBy = " ORDER BY sum(totalQuantity) " + sortOrder;
			else if (sortName.equals("returnQuantitySum"))
				orderBy = " ORDER BY sum(totalQuantityR) " + sortOrder;
			else if (sortName.equals("netQuantitySum"))
				orderBy = " ORDER BY sum(totalQuantity - totalQuantityR) " + sortOrder;
			else if (sortName.equals("salesAmtSum"))
				orderBy = " ORDER BY sum(netAmount) " + sortOrder;
			else if (sortName.equals("returnAmtSum"))
				orderBy = " ORDER BY sum(netAmountR) " + sortOrder;
			else if (sortName.equals("netAmtSum"))
				orderBy = " ORDER BY sum(netAmount - netAmountR) " + sortOrder;
			else if (sortName.equals("netProfit"))
				orderBy = " ORDER BY sum(netAmount - netAmountR - totalCost - totalCostF - discountAmount) " + sortOrder;
			else if (sortName.equals("receiveAmtSum"))
				orderBy = " ORDER BY sum(cardAmount + cashAmount - returnAmount) " + sortOrder;
			else if (sortName.equals("qxAmount"))
				orderBy = " ORDER BY sum(qxAmount) " + sortOrder;
		}
		return orderBy;
	}

	/**
	 * 准备销售统计报表的UI element
	 * @param formBean
	 * @param uiBean
	 */
	public void prepareSalesStatisticReportUIBean(
			ChainReportActionFormBean formBean, ChainReportActionUIBean uiBean, ChainUserInfor userInfor) {
		//1. 检查chain store
		checkChainStoreUsers(formBean, uiBean, userInfor);
		
		//2. 构建year list
		List<Year> years = yearDaoImpl.getAll(true);
		uiBean.setYears(years);
		
		//3. 构建quarter list
		List<Quarter> quarters = quarterDaoImpl.getAll(true);
		uiBean.setQuarters(quarters);	
	}
	

	
	/**
	 * 准备采购统计报表ui
	 * @param formBean
	 * @param uiBean
	 * @param userInfor
	 */
	public void preparePurchaseStatisticReportUIBean(
			ChainReportActionFormBean formBean, ChainReportActionUIBean uiBean,
			ChainUserInfor userInfor) {
		//1. 检查chain store
		if (!ChainUserInforService.isMgmtFromHQ(userInfor)){
			int chainId = userInfor.getMyChainStore().getChain_id();
			ChainStore chainStore = chainStoreService.getChainStoreByID(chainId);
			formBean.setChainStore(chainStore);
		} else {
			ChainStore allChainStore = ChainStoreDaoImpl.getAllChainStoreObject();
			formBean.setChainStore(allChainStore);
		}
		
		//2. 构建year list
		List<Year> years = yearDaoImpl.getAll(true);
		uiBean.setYears(years);
		
		//3. 构建quarter list
		List<Quarter> quarters = quarterDaoImpl.getAll(true);
		uiBean.setQuarters(quarters);	
		
	}

	/**
	 * 准备销售报表的ui
	 * @param formBean
	 * @param uiBean
	 * @param userInfor
	 */
	public void prepareGenSalesReportUI(ChainReportActionFormBean formBean, ChainReportActionUIBean uiBean,
			ChainUserInfor userInfor) {
		//1. 检查chain store
		checkChainStoreUsers(formBean, uiBean, userInfor);
		
	}
	
	private void checkChainStoreUsers(ChainReportActionFormBean formBean, ChainReportActionUIBean uiBean,
			ChainUserInfor userInfor){
		if (!ChainUserInforService.isMgmtFromHQ(userInfor)){
			int chainId = userInfor.getMyChainStore().getChain_id();
			ChainStore chainStore = chainStoreService.getChainStoreByID(chainId);
			formBean.setChainStore(chainStore);
			
			List<ChainUserInfor> salers = new ArrayList<ChainUserInfor>();
			salers.addAll(chainUserInforDaoImpl.getActiveChainUsersByChainStore(chainId));
			uiBean.setChainSalers(salers);
		} else {
			ChainStore allChainStore = ChainStoreDaoImpl.getAllChainStoreObject();
			formBean.setChainStore(allChainStore);
		}
	}

	/**
	 * 生成销售统计报表
	 * result Type:
	 * 1 : level one
	 * 2 : level two
	 * 3 : level three
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param brandId
	 * @return
	 */
	public Response generateSalesStatisticReport(Date startDate, Date endDate,int chainId, int salerId, int yearId,
			int quarterId, int brandId, Pager pager) {
		List<Object> values = new ArrayList<Object>();

		int resultType = 0;
		
		Response response = new Response();
		if (brandId != Common_util.ALL_RECORD && brandId > 0){
			values.add(ChainSalesStatisReportItem.LEVEL_FOUR);
			values = generateSalesStatisticReportLevelFour(startDate, endDate, chainId,salerId, yearId, quarterId, brandId,values, pager);
		} else if (quarterId != Common_util.ALL_RECORD && quarterId >0){
			values.add(ChainSalesStatisReportItem.LEVEL_THREE);
			values = generateSalesStatisticReportLevelThree(startDate, endDate, chainId,salerId, yearId, quarterId,values, pager);
		} else if (yearId != Common_util.ALL_RECORD && yearId >0){
			values.add(ChainSalesStatisReportItem.LEVEL_TWO);
			values = generateSalesStatisticReportLevelTwo(startDate, endDate, chainId,salerId, yearId,values);
		} else if (yearId == Common_util.ALL_RECORD && quarterId == Common_util.ALL_RECORD && brandId == Common_util.ALL_RECORD){
			values.add(ChainSalesStatisReportItem.LEVEL_ONE);
			values = generateSalesStatisticReportLevelOne(startDate, endDate, chainId,salerId,values);
		} else 
			response.setQuickValue(Response.FAIL, "需求信息不充分，无法完成操作");
		
		values.add(resultType);
		
		response.setReturnValue(values);
		
		return response;
	}

	/**
	 * 列出所有年份货品的销售情况
	 * @param values
	 * @param chainId
	 * @param salerId
	 * @param result
	 */
	private List<Object> generateSalesStatisticReportLevelOne(Date startDate,
			Date endDate, int chainId, int salerId,List<Object> result) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String sql = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity), csp.productBarcode.product.year.year_ID, csp.type   FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";
		
		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		
		if (salerId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.saler.user_id = ? ";
			value_sale.add(salerId);
		}	
	
		sql += " GROUP BY csp.productBarcode.product.year.year_ID, csp.type ";
	
		List<Object> values = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//把level one放入对象中
		setChainSalesStatisReportItemLevelOne(values, chainId, salerId, startDate, endDate, result);

		return result;
	}


	private void setChainSalesStatisReportItemLevelOne(
			List<Object> values, int chainId, int salerId, Date startDate,
			Date endDate, List<Object> result ) {
		List<ChainSalesStatisReportItemLevelOne> levelOneItems = new ArrayList<ChainSalesStatisReportItemLevelOne>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		ChainUserInfor saler = this.getThisChainUserInfor(salerId);
		
		ChainSalesStatisReportItem totalItem = new ChainSalesStatisReportItem(chainStore, saler, startDate, endDate);
		
		if (values != null){
			Map<Integer, ChainSalesStatisReportItemLevelOne> dataMap = new HashMap<Integer, ChainSalesStatisReportItemLevelOne>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int yearId = Common_util.getInt(records[4]);
				int type = Common_util.getInt(records[5]);
				
				ChainSalesStatisReportItemLevelOne levelOneItem = dataMap.get(yearId);
				if (levelOneItem != null){
					levelOneItem.putValue(quantity, type, sales, cost, salesDiscount);
				} else {
					levelOneItem = new ChainSalesStatisReportItemLevelOne();
					
					Year year = yearDaoImpl.get(yearId, true);
					
					levelOneItem.putValue(quantity, type, sales, cost, salesDiscount,year, chainStore, saler);
					
					dataMap.put(yearId, levelOneItem);
				}
			}
			
			List<Integer> yearKey = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(yearKey);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer yearId : yearKey){
				ChainSalesStatisReportItemLevelOne levelOneItem = dataMap.get(yearId);
				levelOneItem.reCalculate();
				
				totalItem.add(levelOneItem);
				levelOneItems.add(levelOneItem);
			}	
		}

		result.add(levelOneItems);
		result.add(totalItem);
	}

	/**
	 * 列出某个年份下，所有季度的销售情况
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param result
	 * @return
	 */
	private List<Object> generateSalesStatisticReportLevelTwo(Date startDate,
			Date endDate, int chainId, int salerId, int yearId,List<Object> result) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String sql = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity),  csp.productBarcode.product.quarter.quarter_ID, csp.type   FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";
		
		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		
		if (salerId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.saler.user_id = ? ";
			value_sale.add(salerId);
		}	
		
		//if (yearId != Common_util.ALL_RECORD){
		sql += "AND csp.productBarcode.product.year.year_ID = ? ";
		value_sale.add(yearId);
		//}	
	
		sql += " GROUP BY csp.productBarcode.product.quarter.quarter_ID, csp.type ";
	
		List<Object> values = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//把level two放入对象中
		setChainSalesStatisReportItemLevelTwo(values, chainId, salerId, yearId,startDate, endDate,result);

		return result;
	}

	private void setChainSalesStatisReportItemLevelTwo(List<Object> values,
			int chainId, int salerId, int yearId,Date startDate,
			Date endDate, List<Object> result) {
		List<ChainSalesStatisReportItemLevelTwo> levelTwoItems = new ArrayList<ChainSalesStatisReportItemLevelTwo>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		ChainUserInfor saler = this.getThisChainUserInfor(salerId);
		Year year = yearDaoImpl.get(yearId, true);
		
		ChainSalesStatisReportItem totalItem = new ChainSalesStatisReportItem(chainStore, saler, startDate, endDate);
		
		if (values != null){
			Map<Integer, ChainSalesStatisReportItemLevelTwo> dataMap = new HashMap<Integer, ChainSalesStatisReportItemLevelTwo>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int quarterId = Common_util.getInt(records[4]);
				int type = Common_util.getInt(records[5]);
				
				ChainSalesStatisReportItemLevelTwo levelTwoItem = dataMap.get(quarterId);
				if (levelTwoItem != null){
					levelTwoItem.putValue(quantity, type, sales, cost, salesDiscount);
				} else {
					levelTwoItem = new ChainSalesStatisReportItemLevelTwo();
					
					Quarter quarter = quarterDaoImpl.get(quarterId, true);
					
					levelTwoItem.putValue(quantity, type, sales, cost, salesDiscount, year, quarter, chainStore, saler);
					
					dataMap.put(quarterId, levelTwoItem);
				}
			}
			
			List<Integer> quarterKey = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(quarterKey);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer quarterId : quarterKey){
				ChainSalesStatisReportItemLevelTwo levelTwoItem = dataMap.get(quarterId);
				levelTwoItem.reCalculate();
				
				totalItem.add(levelTwoItem);
				levelTwoItems.add(levelTwoItem);
			}	
		}

		result.add(levelTwoItems);
		result.add(totalItem);
		
	}

	/**
	 * 列出某个年份，某个季度下的，所有货品销售情况
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param result
	 * @return
	 */
	private List<Object> generateSalesStatisticReportLevelThree(Date startDate,
			Date endDate, int chainId, int salerId, int yearId, int quarterId,List<Object> result, Pager pager) {
		List<Object> value_sale = new ArrayList<Object>();
		
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String criteria = " FROM ChainStoreSalesOrderProduct csp WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";
		
		if (chainId != Common_util.ALL_RECORD){
			criteria += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			criteria += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		
		if (salerId != Common_util.ALL_RECORD){
			criteria += "AND csp.chainSalesOrder.saler.user_id = ? ";
			value_sale.add(salerId);
		}	

		criteria += "AND csp.productBarcode.product.year.year_ID = ? ";
		value_sale.add(yearId);
		
		criteria += "AND csp.productBarcode.product.quarter.quarter_ID = ? ";
		value_sale.add(quarterId);
		
		//1. calculate the pager
		if (pager.getTotalResult() == 0){
			String count_sql = "SELECT COUNT(DISTINCT csp.productBarcode.product.brand.brand_ID) " + criteria;
			List<Object> values = chainSalesOrderDaoImpl.executeHQLSelect(count_sql, value_sale.toArray(), null, true);
			int numberOfRecords = Common_util.getInt(values.get(0));
			
			pager.initialize(numberOfRecords);
		} else {
			pager.calFirstResult();
		}
		
		/**
		 * 1. get this page's brand names
		 */
		Integer[] page = new Integer[]{pager.getFirstResult(), pager.getRecordPerPage()};
		String getBrandSql = "SELECT DISTINCT csp.productBarcode.product.brand.brand_ID " + criteria + " ORDER BY csp.productBarcode.product.brand.brand_ID DESC";
		List<Object> brandIds = chainSalesOrderDaoImpl.executeHQLSelect(getBrandSql, value_sale.toArray(), page, true);
		
		List<Object> values = new ArrayList<Object>();
		String criteriaGroupBy = criteria;
		if (brandIds != null && brandIds.size() >0){
			criteriaGroupBy += " AND csp.productBarcode.product.brand.brand_ID in (";
			for (Object brandId: brandIds){
				criteriaGroupBy += brandId + ",";
			}
			criteriaGroupBy += brandIds.get(0) + ") ";
			
			String sql = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity),  csp.productBarcode.product.brand.brand_ID, csp.type" + criteriaGroupBy;
	
			       sql += " GROUP BY csp.productBarcode.product.brand.brand_ID, csp.type";
		
			
			values = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		}
		
		/**
		 * 2. 计算总数
		 */
		String sql_total = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity), csp.type" + criteria;
			   sql_total += " GROUP BY csp.type ";
		List<Object> value_total = chainSalesOrderDaoImpl.executeHQLSelect(sql_total, value_sale.toArray(), null, true);
		
		
		/**
		 * 3. 把level three放入对象中
		 */
		setChainSalesStatisReportItemLevelThree(values, value_total, chainId, salerId, yearId, quarterId, startDate, endDate, result);
		

		return result;
	}
	
	private void setChainSalesStatisReportItemLevelThree(List<Object> values,List<Object> valueTotal,
			int chainId, int salerId, int yearId, int quarterId,Date startDate,
			Date endDate,List<Object> result) {
		List<ChainSalesStatisReportItemLevelThree> levelThreeItems = new ArrayList<ChainSalesStatisReportItemLevelThree>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		ChainUserInfor saler = this.getThisChainUserInfor(salerId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		
		ChainSalesStatisReportItemLevelThree totalItem = new ChainSalesStatisReportItemLevelThree(chainStore, saler, startDate, endDate, year, quarter, null);
		
		/**
		 * 1. 把每个brand的销售信息放入
		 */
		if (values != null){
			Map<Integer, ChainSalesStatisReportItemLevelThree> dataMap = new HashMap<Integer, ChainSalesStatisReportItemLevelThree>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int brandId = Common_util.getInt(records[4]);
				int type = Common_util.getInt(records[5]);
				
				ChainSalesStatisReportItemLevelThree levelThree = dataMap.get(brandId);
				if (levelThree != null){
					levelThree.putValue(quantity, type, sales, cost, salesDiscount);
				} else {
					levelThree = new ChainSalesStatisReportItemLevelThree();
					
					Brand brand = brandDaoImpl.get(brandId, true);
					
					levelThree.putValue(quantity, type, sales, cost, salesDiscount, year, quarter, brand, chainStore, saler);
					
					dataMap.put(brandId, levelThree);
				}
			}
			
			List<Integer> brandKey = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(brandKey);
			
			//1. 把基本对象放入
			for (Integer brandId : brandKey){
				ChainSalesStatisReportItemLevelThree levelThreeItem = dataMap.get(brandId);
				levelThreeItem.reCalculate();

				levelThreeItems.add(levelThreeItem);
			}	
		}
		
		/**
		 * 2. 把总数对象放入
		 */
		if (valueTotal != null){
			for (Object record : valueTotal ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int type = Common_util.getInt(records[4]);
				
				totalItem.putValue(quantity, type, sales, cost, salesDiscount, year, quarter, null, chainStore, saler);
			}
			totalItem.reCalculate();
		}

		result.add(levelThreeItems);
		result.add(totalItem);
		
	}

	/**
	 * 列出某个年份，某个季度，某个品牌的销售情况
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param brandId
	 * @param result
	 * @return
	 */
	private List<Object> generateSalesStatisticReportLevelFour(Date startDate, Date endDate, int chainId,int salerId, 
			int yearId, int quarterId, int brandId, List<Object> result, Pager pager) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String criteria = " FROM ChainStoreSalesOrderProduct csp WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";
		
		if (chainId != Common_util.ALL_RECORD){
			criteria += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			criteria += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		
		if (salerId != Common_util.ALL_RECORD){
			criteria += "AND csp.chainSalesOrder.saler.user_id = ? ";
			value_sale.add(salerId);
		}	
		
		if (yearId != Common_util.ALL_RECORD){
		    criteria += "AND csp.productBarcode.product.year.year_ID = ? ";
		    value_sale.add(yearId);
		}
		
		if (quarterId  != Common_util.ALL_RECORD) {
			criteria += "AND csp.productBarcode.product.quarter.quarter_ID = ? ";
			value_sale.add(quarterId);
		}
		
		if (brandId  != Common_util.ALL_RECORD) {
		    criteria += "AND csp.productBarcode.product.brand.brand_ID = ? ";
		    value_sale.add(brandId);
		}
		
		//1. calculate the pager
		if (pager != null)
		   if (pager.getTotalResult() == 0){
			  String count_sql = "SELECT COUNT(DISTINCT csp.productBarcode.id) " + criteria;
			  List<Object> values = chainSalesOrderDaoImpl.executeHQLSelect(count_sql, value_sale.toArray(), null, true);
			  int numberOfRecords = Common_util.getInt(values.get(0));
			
			  pager.initialize(numberOfRecords);
		   } else {
			  pager.calFirstResult();
		   }
		
		/**
		 * 1. 获取每个barcode下的统计
		 */
		Integer[] page = null;
		if (pager != null )
		    page = new Integer[]{pager.getFirstResult(), pager.getRecordPerPage()};
		
		String getProductSql = "SELECT DISTINCT csp.productBarcode.id " + criteria + " ORDER BY csp.productBarcode.product.productCode DESC";
		List<Object> productIds = chainSalesOrderDaoImpl.executeHQLSelect(getProductSql, value_sale.toArray(), page, true);
		
		List<Object> values = new ArrayList<Object>();
		String criteriaGroupBy = criteria;
		if (productIds != null && productIds.size() >0){
			criteriaGroupBy += " AND csp.productBarcode.id in (";
			for (Object productId: productIds){
				criteriaGroupBy += productId + ",";
			}
			criteriaGroupBy += productIds.get(0) + ") ";
			
			String sql = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity),  csp.productBarcode.id, csp.type " + criteriaGroupBy; 
			       
			       sql += " GROUP BY csp.productBarcode.id, csp.type ";
		
			values = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		}
		
		/**
		 * 2. 计算总数
		 */
		String sql_total = "SELECT SUM(quantity), SUM(retailPrice * discountRate * quantity), SUM(costPrice * quantity), SUM(retailPrice * (1 - discountRate) * quantity),  csp.type" + criteria;
			   sql_total += " GROUP BY csp.type ";
		List<Object> value_total = chainSalesOrderDaoImpl.executeHQLSelect(sql_total, value_sale.toArray(), null, true);

		/**
		 * 3. 把level three放入对象中
		 */
		setChainSalesStatisReportItemLevelFour(values, value_total, chainId, salerId, yearId, quarterId, brandId,startDate,endDate, result);

		return result;
	}
	
	private void setChainSalesStatisReportItemLevelFour(List<Object> values,List<Object> valueTotal,
			int chainId, int salerId, int yearId, int quarterId, int brandId, Date startDate,
			Date endDate,List<Object> result) {
		List<ChainSalesStatisReportItemLevelFour> levelFourItems = new ArrayList<ChainSalesStatisReportItemLevelFour>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		ChainUserInfor saler = this.getThisChainUserInfor(salerId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		Brand brand = brandDaoImpl.get(brandId, true);
		
		ChainSalesStatisReportItemLevelFour totalItem = new ChainSalesStatisReportItemLevelFour(chainStore, saler, startDate, endDate, year, quarter, brand, null);
		
		/**
		 * 1.设置基础数字
		 */
		if (values != null){
			Map<Integer, ChainSalesStatisReportItemLevelFour> dataMap = new HashMap<Integer, ChainSalesStatisReportItemLevelFour>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int productBarcodeId = Common_util.getInt(records[4]);
				int type = Common_util.getInt(records[5]);
				
				ChainSalesStatisReportItemLevelFour levelFour = dataMap.get(productBarcodeId);
				if (levelFour != null){
					levelFour.putValue(quantity, type, sales, cost, salesDiscount);
				} else {
					levelFour = new ChainSalesStatisReportItemLevelFour();
					
					ProductBarcode productBarcode = productBarcodeDaoImpl.get(productBarcodeId, true);
					
					levelFour.putValue(quantity, type, sales, cost, salesDiscount, year, quarter, brand, productBarcode, chainStore, saler);
					
					dataMap.put(productBarcodeId, levelFour);
				}
			}
			
			List<Integer> productBarcodeIds = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(productBarcodeIds);
			
			//1. 把基本对象放入
			for (Integer productBarcodeId : productBarcodeIds){
				ChainSalesStatisReportItemLevelFour levelFourItem = dataMap.get(productBarcodeId);
				levelFourItem.reCalculate();

				levelFourItems.add(levelFourItem);
			}	
		}
		
		/**
		 * 2. 把总数对象放入
		 */
		if (valueTotal != null){
			for (Object record : valueTotal ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double sales = Common_util.getDouble(records[1]);
				double cost = Common_util.getDouble(records[2]);
				double salesDiscount = Common_util.getDouble(records[3]);
				int type = Common_util.getInt(records[4]);
				
				totalItem.putValue(quantity, type, sales, cost, salesDiscount, year, quarter, brand, null, chainStore, saler);
			}
			totalItem.reCalculate();
		}

		result.add(levelFourItems);
		result.add(totalItem);
	}

	/**
	 * 本业务的方法，对于chainId=全部，需要另外处理
	 * @param chainId
	 * @return
	 */
	private ChainStore getThisChainStore(int chainId){
		ChainStore chainStore = new ChainStore();
		if (chainId == Common_util.ALL_RECORD)
			chainStore = chainStoreDaoImpl.getAllChainStoreObject();
		else 
			chainStore = chainStoreDaoImpl.get(chainId, true);
		return chainStore;
	}
	
	/**
	 * 本业务的方法，对于userId=全部，需要另外处理
	 * @param chainId
	 * @return
	 */	
	private ChainUserInfor getThisChainUserInfor(int userId){
		ChainUserInfor saler = new ChainUserInfor();

		if (userId == Common_util.ALL_RECORD)
			saler = chainUserInforDaoImpl.getAllChainUserObject();
		else 
			saler = chainUserInforDaoImpl.get(userId, true);
		
		return saler;
	}

	/**
	 * 生成采购统计报表
	 * 
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param brandId
	 * @param pager
	 * @return
	 */
	public Response generatePurchaseStatisticReport(Date startDateSQL,
			Date endDateSQL, int chainId, int yearId, int quarterId, int brandId,
			Pager pager) {
		Date startDate = Common_util.formStartDate(startDateSQL);
		Date endDate = Common_util.formEndDate(endDateSQL);
		List<Object> values = new ArrayList<Object>();

		int resultType = 0;
		
		Response response = new Response();
		if (brandId != Common_util.ALL_RECORD && brandId > 0){
			values.add(ChainPurchaseStatisReportItem.LEVEL_FOUR);
			values = generatePurchaseStatisticReportLevelFour(startDate, endDate, chainId,yearId, quarterId, brandId,values, pager);
		} else if (quarterId != Common_util.ALL_RECORD && quarterId >0){
			values.add(ChainPurchaseStatisReportItem.LEVEL_THREE);
			values = generatePurchaseStatisticReportLevelThree(startDate, endDate, chainId,yearId, quarterId,values, pager);
		} else if (yearId != Common_util.ALL_RECORD && yearId >0){
			values.add(ChainPurchaseStatisReportItem.LEVEL_TWO);
			values = generatePurchaseStatisticReportLevelTwo(startDate, endDate, chainId,yearId,values);
		} else if (yearId == Common_util.ALL_RECORD && quarterId == Common_util.ALL_RECORD && brandId == Common_util.ALL_RECORD){
			values.add(ChainPurchaseStatisReportItem.LEVEL_ONE);
			values = generatePurchaseStatisticReportLevelOne(startDate, endDate, chainId,values);
		} else 
			response.setQuickValue(Response.FAIL, "需求信息不充分，无法完成操作");
		
		values.add(resultType);
		
		response.setReturnValue(values);
		
		return response;
	}


	private List<Object> generatePurchaseStatisticReportLevelOne(
			Date startDate, Date endDate, int chainId, List<Object> result) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String sql = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.productBarcode.product.year.year_ID, p.order.order_type   FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ?";

		
		if (chainId != Common_util.ALL_RECORD){
			sql += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
			   value_sale.add(chainStore.getClient_id());
			else 
			   value_sale.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale);
			if (chainSQL != null )
			    sql += "AND " + chainSQL;
		}

	
		sql += " GROUP BY p.productBarcode.product.year.year_ID, p.order.order_type";
	
		List<Object> values = inventoryOrderProductDAOImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//把level one放入对象中
		setChainPurchaseStatisReportItemLevelOne(values, chainId, startDate, endDate, result);

		return result;
	}

	private void setChainPurchaseStatisReportItemLevelOne(List<Object> values,
			int chainId, Date startDate, Date endDate, List<Object> result) {
	    List<ChainPurchaseStatisReportItemLevelOne> levelOneItems = new ArrayList<ChainPurchaseStatisReportItemLevelOne>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		
		ChainPurchaseStatisReportItem totalItem = new ChainPurchaseStatisReportItem(chainStore, startDate, endDate);
		
		if (values != null){
			Map<Integer, ChainPurchaseStatisReportItemLevelOne> dataMap = new HashMap<Integer, ChainPurchaseStatisReportItemLevelOne>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int yearId = Common_util.getInt(records[2]);
				int type = Common_util.getInt(records[3]);
				
				ChainPurchaseStatisReportItemLevelOne levelOneItem = dataMap.get(yearId);
				if (levelOneItem != null){
					levelOneItem.putValue(type, quantity, amount);
				} else {
					levelOneItem = new ChainPurchaseStatisReportItemLevelOne();
					
					Year year = yearDaoImpl.get(yearId, true);
					
					levelOneItem.putValue(chainStore, year,type, quantity, amount);
					
					dataMap.put(yearId, levelOneItem);
				}
			}
			
			List<Integer> yearKey = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(yearKey);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer yearId : yearKey){
				ChainPurchaseStatisReportItemLevelOne levelOneItem = dataMap.get(yearId);
				levelOneItem.reCalculate();
				
				totalItem.add(levelOneItem);
				levelOneItems.add(levelOneItem);
			}
			
			totalItem.reCalculate();
		}

		result.add(levelOneItems);
		result.add(totalItem);
		
	}

	private List<Object> generatePurchaseStatisticReportLevelTwo(
			Date startDate, Date endDate, int chainId, int yearId, List<Object> result) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale.add(yearId);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String sql = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.productBarcode.product.quarter.quarter_ID, p.order.order_type   FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.productBarcode.product.year.year_ID =? AND p.order.order_EndTime BETWEEN ? AND ?";

		
		if (chainId != Common_util.ALL_RECORD){
			sql += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
			   value_sale.add(chainStore.getClient_id());
			else 
			   value_sale.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale);
			if (chainSQL != null )
			    sql += "AND " + chainSQL;
		}

	
		sql += " GROUP BY p.productBarcode.product.quarter.quarter_ID, p.order.order_type";
	
		List<Object> values = inventoryOrderProductDAOImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//把level one放入对象中
		setChainPurchaseStatisReportItemLevelTwo(values, chainId, yearId, startDate, endDate, result);

		return result;
	}

	private void setChainPurchaseStatisReportItemLevelTwo(List<Object> values,
			int chainId, int yearId, Date startDate, Date endDate, List<Object> result) {
	    List<ChainPurchaseStatisReportItemLevelOne> levelOneItems = new ArrayList<ChainPurchaseStatisReportItemLevelOne>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		
		ChainPurchaseStatisReportItem totalItem = new ChainPurchaseStatisReportItem(chainStore, startDate, endDate);
		
		if (values != null){
			Map<Integer, ChainPurchaseStatisReportItemLevelTwo> dataMap = new HashMap<Integer, ChainPurchaseStatisReportItemLevelTwo>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int quarterId = Common_util.getInt(records[2]);
				int type = Common_util.getInt(records[3]);
				
				ChainPurchaseStatisReportItemLevelTwo levelOneItem = dataMap.get(quarterId);
				if (levelOneItem != null){
					levelOneItem.putValue(type, quantity, amount);
				} else {
					levelOneItem = new ChainPurchaseStatisReportItemLevelTwo();
					
					Quarter quarter = quarterDaoImpl.get(quarterId, true);
					
					levelOneItem.putValue(chainStore, year, quarter, type, quantity, amount);
					
					dataMap.put(quarterId, levelOneItem);
				}
			}
			
			List<Integer> quarterKeys = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(quarterKeys);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer quarterId : quarterKeys){
				ChainPurchaseStatisReportItemLevelTwo levelOneItem = dataMap.get(quarterId);
				levelOneItem.reCalculate();
				
				totalItem.add(levelOneItem);
				levelOneItems.add(levelOneItem);
			}	
			
			totalItem.reCalculate();
		}

		result.add(levelOneItems);
		result.add(totalItem);
	}
	
	private List<Object> generatePurchaseStatisticReportLevelThree(
			Date startDate, Date endDate, int chainId, int yearId, int quarterId, List<Object> result, Pager pager) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale.add(yearId);
		value_sale.add(quarterId);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String criteria = "  FROM InventoryOrderProduct p WHERE p.order.order_Status = ? AND p.productBarcode.product.year.year_ID =? AND p.productBarcode.product.quarter.quarter_ID=? AND p.order.order_EndTime BETWEEN ? AND ?";

		if (chainId != Common_util.ALL_RECORD){
			criteria += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
			   value_sale.add(chainStore.getClient_id());
			else 
			   value_sale.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale);
			if (chainSQL != null )
				criteria += " AND " + chainSQL;
		}

		//1. calculate the pager
		if (pager.getTotalResult() == 0){
			String count_sql = "SELECT COUNT(DISTINCT p.productBarcode.product.brand.brand_ID) " + criteria;
			List<Object> values = inventoryOrderProductDAOImpl.executeHQLSelect(count_sql, value_sale.toArray(), null, true);
			int numberOfRecords = Common_util.getInt(values.get(0));
			
			pager.initialize(numberOfRecords);
		} else {
			pager.calFirstResult();
		}
		
		/**
		 * 1. 获取每个brand的细分总数
		 */
		Integer[] page = new Integer[]{pager.getFirstResult(), pager.getRecordPerPage()};
		String getBrandSql = "SELECT DISTINCT p.productBarcode.product.brand.brand_ID " + criteria + " ORDER BY p.productBarcode.product.brand.brand_ID DESC";
		List<Object> brandIds = inventoryOrderProductDAOImpl.executeHQLSelect(getBrandSql, value_sale.toArray(), page, true);
		
		List<Object> values = new ArrayList<Object>();
		String criteriaGroupBy = criteria;
		if (brandIds != null && brandIds.size() >0){
			criteriaGroupBy += " AND p.productBarcode.product.brand.brand_ID in (";
			for (Object brandId: brandIds){
				criteriaGroupBy += brandId + ",";
			}
			criteriaGroupBy += brandIds.get(0) + ") ";
			
			String sql = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.productBarcode.product.brand.brand_ID, p.order.order_type " +criteriaGroupBy;
			       sql += " GROUP BY p.productBarcode.product.brand.brand_ID, p.order.order_type";
		
			values = inventoryOrderProductDAOImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		}
		
		
		/**
		 * 2. 计算总数
		 */
		String sql_total = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.order.order_type " + criteria;
			   sql_total += " GROUP BY p.order.order_type";
		List<Object> value_total = inventoryOrderProductDAOImpl.executeHQLSelect(sql_total, value_sale.toArray(), null, true);
		
		
		//把level one放入对象中
		setChainPurchaseStatisReportItemLevelThree(values, value_total, chainId, yearId, quarterId, startDate, endDate, result);

		return result;
	}

	private void setChainPurchaseStatisReportItemLevelThree(List<Object> values,List<Object> valueTotal,
			int chainId, int yearId, int quarterId,  Date startDate, Date endDate, List<Object> result) {
	    List<ChainPurchaseStatisReportItemLevelOne> levelOneItems = new ArrayList<ChainPurchaseStatisReportItemLevelOne>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		
		ChainPurchaseStatisReportItemLevelThree totalItem = new ChainPurchaseStatisReportItemLevelThree(chainStore, startDate, endDate, year, quarter, null);
		
		/**
		 * 1. set 基本对象
		 */
		if (values != null){
			Map<Integer, ChainPurchaseStatisReportItemLevelThree> dataMap = new HashMap<Integer, ChainPurchaseStatisReportItemLevelThree>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int brandId = Common_util.getInt(records[2]);
				int type = Common_util.getInt(records[3]);
				
				ChainPurchaseStatisReportItemLevelThree levelOneItem = dataMap.get(brandId);
				if (levelOneItem != null){
					levelOneItem.putValue(type, quantity, amount);
				} else {
					levelOneItem = new ChainPurchaseStatisReportItemLevelThree();
					
					Brand brand = brandDaoImpl.get(brandId, true);
					
					levelOneItem.putValue(chainStore, year, quarter, brand, type, quantity, amount);
					
					dataMap.put(brandId, levelOneItem);
				}
			}
			
			List<Integer> brands = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(brands);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer brandId : brands){
				ChainPurchaseStatisReportItemLevelThree levelOneItem = dataMap.get(brandId);
				levelOneItem.reCalculate();

				levelOneItems.add(levelOneItem);
			}	
		}

		/**
		 * 2. 把总数对象放入
		 */
		if (valueTotal != null){
			for (Object record : valueTotal ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int type = Common_util.getInt(records[2]);
				
				totalItem.putValue(chainStore, year, quarter, null, type, quantity, amount);
			}
			totalItem.reCalculate();
		}

		result.add(levelOneItems);
		result.add(totalItem);
	}
	
	private List<Object> generatePurchaseStatisticReportLevelFour(
			Date startDate, Date endDate, int chainId, int yearId, int quarterId, int brandId, List<Object> result, Pager pager) {
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale.add(yearId);
		value_sale.add(quarterId);
		value_sale.add(brandId);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		String criteria = "  FROM InventoryOrderProduct p WHERE p.order.order_Status = ? AND p.productBarcode.product.year.year_ID =? AND p.productBarcode.product.quarter.quarter_ID=? AND p.productBarcode.product.brand.brand_ID=? AND p.order.order_EndTime BETWEEN ? AND ?";
		//

		
		if (chainId != Common_util.ALL_RECORD){
			criteria += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
			   value_sale.add(chainStore.getClient_id());
			else 
			   value_sale.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale);
			if (chainSQL != null )
				criteria += "AND " + chainSQL;
		}
		
		if (pager.getTotalResult() == 0){
			String count_sql = "SELECT COUNT(DISTINCT p.productBarcode.id) " + criteria;
			List<Object> values = inventoryOrderProductDAOImpl.executeHQLSelect(count_sql, value_sale.toArray(), null, true);
			int numberOfRecords = Common_util.getInt(values.get(0));
			
			pager.initialize(numberOfRecords);
		} else {
			pager.calFirstResult();
		}

		/**
		 * 1. 计算每款的总数
		 */
		Integer[] page = new Integer[]{pager.getFirstResult(), pager.getRecordPerPage()};
		String getProductSql = "SELECT DISTINCT p.productBarcode.id " + criteria + " ORDER BY p.productBarcode.product.productCode DESC";
		List<Object> productIds = inventoryOrderProductDAOImpl.executeHQLSelect(getProductSql, value_sale.toArray(), page, true);
		
		List<Object> values = new ArrayList<Object>();
		String criteriaGroupBy = criteria;
		if (productIds != null && productIds.size() >0){
			criteriaGroupBy += " AND p.productBarcode.id in (";
			for (Object productId: productIds){
				criteriaGroupBy += productId + ",";
			}
			criteriaGroupBy += productIds.get(0) + ") ";
			criteriaGroupBy += " GROUP BY p.productBarcode.id, p.order.order_type";
			
			String sql = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.productBarcode.id, p.order.order_type " + criteriaGroupBy;
	
		    values = inventoryOrderProductDAOImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		}
		
		
		/**
		 * 2. 计算总数
		 */
		String sql_total = "SELECT SUM(quantity), SUM(wholeSalePrice * quantity), p.order.order_type " + criteria;
			   sql_total += " GROUP BY p.order.order_type";
		List<Object> value_total = inventoryOrderProductDAOImpl.executeHQLSelect(sql_total, value_sale.toArray(), null, true);

		//把level four放入对象中
		setChainPurchaseStatisReportItemLevelFour(values, value_total, chainId, yearId, quarterId, brandId, startDate, endDate, result);

		return result;
	}

	private void setChainPurchaseStatisReportItemLevelFour(List<Object> values, List<Object> valueTotal,
			int chainId, int yearId, int quarterId, int brandId,  Date startDate, Date endDate, List<Object> result) {
	    List<ChainPurchaseStatisReportItemLevelOne> levelOneItems = new ArrayList<ChainPurchaseStatisReportItemLevelOne>();
		
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		Brand brand = brandDaoImpl.get(brandId, true);
		
		ChainPurchaseStatisReportItemLevelFour totalItem = new ChainPurchaseStatisReportItemLevelFour(chainStore, startDate, endDate, year, quarter, brand, null);
		
		if (values != null){
			Map<Integer, ChainPurchaseStatisReportItemLevelFour> dataMap = new HashMap<Integer, ChainPurchaseStatisReportItemLevelFour>();
			for (Object record : values ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int productId = Common_util.getInt(records[2]);
				int type = Common_util.getInt(records[3]);
				
				ChainPurchaseStatisReportItemLevelFour levelOneItem = dataMap.get(productId);
				if (levelOneItem != null){
					levelOneItem.putValue(type, quantity, amount);
				} else {
					levelOneItem = new ChainPurchaseStatisReportItemLevelFour();
					
					ProductBarcode pb = productBarcodeDaoImpl.get(productId, true);
					
					levelOneItem.putValue(chainStore, year, quarter, brand, pb, type, quantity, amount);
					
					dataMap.put(productId, levelOneItem);
				}
			}
			
			List<Integer> pbs = new ArrayList<Integer>(dataMap.keySet());
			Collections.sort(pbs);
			
			//1. 把基本对象放入
			//2. 计算总数
			for (Integer pbId : pbs){
				ChainPurchaseStatisReportItemLevelFour levelOneItem = dataMap.get(pbId);
				levelOneItem.reCalculate();

				levelOneItems.add(levelOneItem);
			}	
		}
		

		/**
		 * 2. 把总数对象放入
		 */
		if (valueTotal != null){
			for (Object record : valueTotal ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				double amount = Common_util.getDouble(records[1]);
				int type = Common_util.getInt(records[2]);
				
				totalItem.putValue(chainStore, year, quarter, brand, null, type, quantity, amount);
			}
			totalItem.reCalculate();
		}

		result.add(levelOneItems);
		result.add(totalItem);
	}
	
	
	/**
	 * 获取每周的前几名的信息然后展示在首页
	 * @return
	 */
	@Transactional
	public Response getWeeklyTop(ChainUserInfor userInfor){
		Response response = new Response();
		ChainWMRank weeklyRank = new ChainWMRank();
		
		/**
		 * 获取连锁店前几名
		 */
		List<java.sql.Date> lastWeekDays = Common_util.getLastWeekDays();
		DetachedCriteria criteria = DetachedCriteria.forClass(ChainWeeklySales.class);
		criteria.add(Restrictions.eq("reportDate", lastWeekDays.get(0)));
		criteria.addOrder(Order.asc("rank"));
		criteria.add(Restrictions.le("rank", Common_util.WEEK_RANK));
		
		List<ChainWeeklySales> weeklySales = chainWeeklySalesDaoImpl.getByCritera(criteria, true);
		List<ChainWMRankItem> rankItems = new ArrayList<ChainWMRankItem>();
		
		for (ChainWeeklySales weeklySale: weeklySales){
			ChainStore chainStore = weeklySale.getChainStore();
			chainWeeklySalesDaoImpl.initialize(chainStore);
			
			int salesQ = weeklySale.getNetSalesQuantity();
			int salesAmt = (int)weeklySale.getNetSalesAmount();
			int rank = weeklySale.getRank();
			
			ChainWMRankItem rankItem = new ChainWMRankItem();
			
			String salesQS = String.valueOf(salesQ);
			String salesAmtS = String.valueOf(salesAmt);
			
			//salesQS = "*" + salesQS.substring(1);
			salesAmtS = "*" + salesAmtS.substring(1);
			
			rankItem.setChainStore(chainStore);
			rankItem.setRank(rank);
			rankItem.setSaleQ(salesQS);
			rankItem.setSaleAmt(salesAmtS);
			
			rankItems.add(rankItem);
		}
		
		weeklyRank.setItems(rankItems);
		weeklyRank.setStartDate(lastWeekDays.get(0));
		weeklyRank.setEndDate(lastWeekDays.get(6));
		
		/**
		 * 获取我的名次
		 */
		ChainWMRankItem myRank = new ChainWMRankItem();
		if (userInfor.getMyChainStore() != null && userInfor.getMyChainStore().getChain_id() != Common_util.ALL_RECORD){
			DetachedCriteria criteria2 = DetachedCriteria.forClass(ChainWeeklySales.class);
			criteria2.add(Restrictions.eq("reportDate", lastWeekDays.get(0)));
			criteria2.add(Restrictions.eq("chainStore.chain_id", userInfor.getMyChainStore().getChain_id()));
			
			List<ChainWeeklySales> weeklySales2 = chainWeeklySalesDaoImpl.getByCritera(criteria2, true);
			if (weeklySales2 != null && weeklySales2.size()>0){
				ChainWeeklySales mySales = weeklySales2.get(0);
				ChainStore chainStore = mySales.getChainStore();
				chainWeeklySalesDaoImpl.initialize(chainStore);
				
				int salesQ = mySales.getNetSalesQuantity();
				int salesAmt = (int)mySales.getNetSalesAmount();
				int rank = mySales.getRank();

				
				myRank.setChainStore(chainStore);
				myRank.setRank(rank);
				myRank.setSaleQ(String.valueOf(salesQ));
				myRank.setSaleAmt(String.valueOf(salesAmt));
				
			}
		}
		int numOfRank = chainStoreService.getNumOfActiveChainStore();
		myRank.setTotalRank(numOfRank);
		
		List<Object> returnValue = new ArrayList<Object>();
		returnValue.add(weeklyRank);
		returnValue.add(myRank);
		
		response.setReturnValue(returnValue);
		response.setReturnCode(Response.SUCCESS);
		
		return response;
		
	}
	
	/**
	 * 
	 * @return
	 */
	private String constructChainSQL(String prefix,List<Object> value_sale){
		List<ChainStore> stores = chainStoreService.getAvailableClientChainstores();
		prefix += " IN (";
		if (stores != null && stores.size() > 0){
			for (int i = 0; i < stores.size();i++){
				ChainStore chainStore = stores.get(i);
				if (i == stores.size()-1)
				    prefix += chainStore.getClient_id() + ")";
				else 
					prefix += chainStore.getClient_id() + ",";
			}
			return prefix;
		} else 
			return null;
	}

	/**
	 * 创建销售报表到excel
	 * @param dataMap
	 * @param string
	 * @return
	 */
	public Map<String, Object> generateSalesRptExcel(Map dataMap, String path, Date startDate, Date endDate) {
		Map<String,Object> returnMap=new HashMap<String, Object>();   

		ByteArrayInputStream byteArrayInputStream;   
		try {     
			HSSFWorkbook wb = null;   
			
			//to get the order information from database
			List<ChainSalesReport> rptEles = (List<ChainSalesReport>)dataMap.get("rows");
			List<ChainSalesReport> footer =  (List<ChainSalesReport>)dataMap.get("footer");
			
			ChainSalesReportTemplate rptTemplate = new ChainSalesReportTemplate(rptEles, footer.get(0), startDate, endDate, path);
			wb = rptTemplate.process();

			ByteArrayOutputStream os = new ByteArrayOutputStream();   
			try {   
			    wb.write(os);   
			} catch (IOException e) {   
				loggerLocal.error(e);
		    }   
		    byte[] content = os.toByteArray();   
		    byteArrayInputStream = new ByteArrayInputStream(content);   
		    returnMap.put("stream", byteArrayInputStream);   
         
		    return returnMap;   
		 } catch (Exception ex) {   
			 loggerLocal.error(ex);
		 }   
		return null;   
	}

	/**
	 * 计算综合报表数据
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param yearId
	 * @param quarterId
	 * @param brandId
	 * @param pager
	 * @return
	 */
	public Response generateAllInOneReport(Date startDateSQL,
			Date endDateSQL, int chainId, int yearId, int quarterId,
			int brandId, Pager pager) {
		Date startDate = Common_util.formStartDate(startDateSQL);
		Date endDate = Common_util.formEndDate(endDateSQL);
		Map<String, Object> values = new HashMap<String, Object>();

		Response response = new Response();
		if (brandId != Common_util.ALL_RECORD && brandId > 0){
			values.put("type", ChainPurchaseStatisReportItem.LEVEL_FOUR);
			generateAllInOneReportLevelFour(startDate, endDate, chainId,yearId, quarterId, brandId,values, pager);
		} else if (quarterId != Common_util.ALL_RECORD && quarterId >0){
			values.put("type", ChainPurchaseStatisReportItem.LEVEL_THREE);
			generateAllInOneReportLevelThree(startDate, endDate, chainId,yearId, quarterId,values, pager);
		} else if (yearId != Common_util.ALL_RECORD && yearId >0){
			values.put("type", ChainPurchaseStatisReportItem.LEVEL_TWO);
			generateAllInOneReportLevelTwo(startDate, endDate, chainId,yearId,values);
		} else if (yearId == Common_util.ALL_RECORD && quarterId == Common_util.ALL_RECORD && brandId == Common_util.ALL_RECORD){
			values.put("type", ChainPurchaseStatisReportItem.LEVEL_ONE);
			generateAllInOneReportLevelOne(startDate, endDate, chainId,values);
		} else 
			response.setQuickValue(Response.FAIL, "需求信息不充分，无法完成操作");

		response.setReturnValue(values);
		
		return response;
	}

	/**
	 * 生成综合报表level one数据
	 * @param startDate
	 * @param endDate
	 * @param chainId
	 * @param result
	 * @return
	 */
	private void generateAllInOneReportLevelOne(Date startDate,
			Date endDate, int chainId, Map<String, Object> result) {
		//@1. 生成销售数据
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
        //@2.1 组成total not count inventory
        String notCoundBrandId = "(" + Brand.BRAND_NOT_COUNT_INVENTORY[0] + "," + Brand.BRAND_NOT_COUNT_INVENTORY[1]+")";
		
		String sql = "SELECT SUM(quantity), csp.productBarcode.product.year.year_ID, csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";
		String sql_sales_total = "SELECT SUM(quantity), csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? ";

		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		sql += " GROUP BY csp.productBarcode.product.year.year_ID, csp.type ";
		sql_sales_total += " GROUP BY csp.type ";
		
		List<Object> salesResult = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//@2. 生成销售总数
		List<Object> salesTotalResult = chainSalesOrderDaoImpl.executeHQLSelect(sql_sales_total, value_sale.toArray(), null, true);
		
		//@3. 生成采购数据
		List<Object> value_sale2 = new ArrayList<Object>();
		value_sale2.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale2.add(startDate);
		value_sale2.add(endDate);
		
		String sql2 = "SELECT SUM(quantity), p.productBarcode.product.year.year_ID, p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.brand.brand_ID NOT IN " + notCoundBrandId;
		String sql_purchase_total = "SELECT SUM(quantity), p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.brand.brand_ID NOT IN " + notCoundBrandId;

		if (chainId != Common_util.ALL_RECORD){
			sql2 += "AND p.order.client_id = ? ";
			sql_purchase_total += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
				value_sale2.add(chainStore.getClient_id());
			else 
				value_sale2.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale2);
			if (chainSQL != null ){
			    sql2 += "AND " + chainSQL;
			    sql_purchase_total += "AND " + chainSQL;
			}
		}
		sql2 += " GROUP BY p.productBarcode.product.year.year_ID, p.order.order_type";
		sql_purchase_total += " GROUP BY p.order.order_type";
		List<Object> purchaseResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql2, value_sale2.toArray(), null, true);

		//@4. 生成采购总数
		List<Object> purchaseTotalResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql_purchase_total, value_sale2.toArray(), null, true);

		//@5. 生成库存数据
		String chainCriteria = "";
		ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
		if (chainId == Common_util.ALL_RECORD){
			chainCriteria = " c.clientId <> " + ChainStore.CLIENT_ID_TEST_ID;
		}else{
			chainCriteria = " c.clientId = " + chainStore.getClient_id();	
		}
		String sql_in_out = "SELECT c.productBarcode.product.year.year_ID, SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.product.brand.brand_ID <>? AND c.productBarcode.product.brand.brand_ID <>? GROUP BY c.productBarcode.product.year.year_ID";
        Object[] values = Brand.BRAND_NOT_COUNT_INVENTORY;
		List<Object> inventory = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out, values,null,true);
		
		//@6. 生成库存总数
		String sql_in_out_total = "SELECT SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.product.brand.brand_ID <>? AND c.productBarcode.product.brand.brand_ID <>?";
		List<Object> inventory_total = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out_total, values,null,true);
		
		setAllInOneLevelOneItem(salesResult, purchaseResult, salesTotalResult, purchaseTotalResult, inventory, inventory_total, result, chainId, startDate, endDate);
	}



	private  void generateAllInOneReportLevelTwo(Date startDate,
			Date endDate, int chainId, int yearId, Map<String, Object> result) {
		//@1. 生成销售数据
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		value_sale.add(yearId);
		
        //@2.1 组成total not count inventory
        String notCoundBrandId = "(" + Brand.BRAND_NOT_COUNT_INVENTORY[0] + "," + Brand.BRAND_NOT_COUNT_INVENTORY[1]+")";
		
		String sql = "SELECT SUM(quantity), csp.productBarcode.product.quarter.quarter_ID, csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.product.year.year_ID=?";
		String sql_sales_total = "SELECT SUM(quantity), csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.product.year.year_ID=?";

		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		sql += " GROUP BY csp.productBarcode.product.quarter.quarter_ID, csp.type ";
		sql_sales_total += " GROUP BY csp.type ";
		
		List<Object> salesResult = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//@2. 生成销售总数
		List<Object> salesTotalResult = chainSalesOrderDaoImpl.executeHQLSelect(sql_sales_total, value_sale.toArray(), null, true);
		
		//@3. 生成采购数据
		List<Object> value_sale2 = new ArrayList<Object>();
		value_sale2.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_sale2.add(startDate);
		value_sale2.add(endDate);
		value_sale2.add(yearId);
		
		String sql2 = "SELECT SUM(quantity), p.productBarcode.product.quarter.quarter_ID, p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.year.year_ID=? AND p.productBarcode.product.brand.brand_ID NOT IN " + notCoundBrandId;
		String sql_purchase_total = "SELECT SUM(quantity), p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.year.year_ID=? AND p.productBarcode.product.brand.brand_ID NOT IN " + notCoundBrandId;

		if (chainId != Common_util.ALL_RECORD){
			sql2 += "AND p.order.client_id = ? ";
			sql_purchase_total += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
				value_sale2.add(chainStore.getClient_id());
			else 
				value_sale2.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_sale2);
			if (chainSQL != null ){
			    sql2 += "AND " + chainSQL;
			    sql_purchase_total += "AND " + chainSQL;
			}
		}
		sql2 += " GROUP BY p.productBarcode.product.quarter.quarter_ID, p.order.order_type";
		sql_purchase_total += " GROUP BY p.order.order_type";
		List<Object> purchaseResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql2, value_sale2.toArray(), null, true);

		//@4. 生成采购总数
		List<Object> purchaseTotalResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql_purchase_total, value_sale2.toArray(), null, true);

		//@5. 生成库存数据
		String chainCriteria = "";
		ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
		if (chainId == Common_util.ALL_RECORD){
			chainCriteria = " c.clientId <> " + ChainStore.CLIENT_ID_TEST_ID;
		}else{
			chainCriteria = " c.clientId = " + chainStore.getClient_id();	
		}
		String sql_in_out = "SELECT c.productBarcode.product.quarter.quarter_ID, SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.product.brand.brand_ID <>? AND c.productBarcode.product.brand.brand_ID <>? AND  c.productBarcode.product.year.year_ID=? GROUP BY c.productBarcode.product.quarter.quarter_ID";
        Object[] values = new Object[]{Brand.BRAND_NOT_COUNT_INVENTORY[0], Brand.BRAND_NOT_COUNT_INVENTORY[1],yearId};
	    
		List<Object> inventory = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out, values,null,true);
		
		//@6. 生成库存总数
		String sql_in_out_total = "SELECT SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.product.brand.brand_ID <>? AND c.productBarcode.product.brand.brand_ID <>? AND  c.productBarcode.product.year.year_ID=?";
		List<Object> inventory_total = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out_total, values,null,true);
		
		setAllInOneLevelTwoItem(salesResult, purchaseResult, salesTotalResult, purchaseTotalResult, inventory, inventory_total, result, chainId, yearId, startDate, endDate);
	}

	
	private void generateAllInOneReportLevelThree(Date startDate,
			Date endDate, int chainId, int yearId, int quarterId,
			Map<String, Object> result, Pager pager) {
		//@1. calculate the pager
		if (pager.getTotalResult() == 0){
			int totalBrand = productDaoImpl.getNumOfBrandsUnderYQ(yearId, quarterId);
			pager.initialize(totalBrand);
		} else {
			pager.calFirstResult();
		}
		
		//@1.1 组成sql parameters
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		value_sale.add(yearId);
		value_sale.add(quarterId);
		
		List<Object> value_purchase = new ArrayList<Object>();
		value_purchase.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_purchase.add(startDate);
		value_purchase.add(endDate);
		value_purchase.add(yearId);
		value_purchase.add(quarterId);
		
        List<Object> value_inventory = new ArrayList<Object>();
        value_inventory.add(yearId);
        value_inventory.add(quarterId);
        
        //@2.1 组成total not count inventory
        String notCoundBrandId = "(" + Brand.BRAND_NOT_COUNT_INVENTORY[0] + "," + Brand.BRAND_NOT_COUNT_INVENTORY[1]+")";
		
		//@2. 获取这页的brand ids
		List<Object> brandIds = productDaoImpl.getBrandIdsUnderYQ(yearId, quarterId, pager.getFirstResult(), pager.getRecordPerPage());
		String brandIdSQL = "(";
		if (brandIds.size() != 0)
			for (int i = 0; i < brandIds.size(); i++){
				Object brandId = brandIds.get(i);
				brandIdSQL += brandId;
				if (i == brandIds.size() -1)
					brandIdSQL += ")";
				else 
					brandIdSQL += ",";
			}
		else 
			brandIdSQL ="(0)";
		
		//@3. 生成销售数据
		String sql = "SELECT SUM(quantity), csp.productBarcode.product.brand.brand_ID, csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.product.year.year_ID=? AND csp.productBarcode.product.quarter.quarter_ID=? AND csp.productBarcode.product.brand.brand_ID IN " + brandIdSQL;
		String sql_sales_total = "SELECT SUM(quantity), csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.product.year.year_ID=? AND csp.productBarcode.product.quarter.quarter_ID=? ";

		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		sql += " GROUP BY csp.productBarcode.product.brand.brand_ID, csp.type ";
		sql_sales_total += " GROUP BY csp.type ";
		
		List<Object> salesResult = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//@2. 生成销售总数
		List<Object> salesTotalResult = chainSalesOrderDaoImpl.executeHQLSelect(sql_sales_total, value_sale.toArray(), null, true);
		
		//@3. 生成采购数据
		String sql2 = "SELECT SUM(quantity), p.productBarcode.product.brand.brand_ID, p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.year.year_ID=?  AND p.productBarcode.product.quarter.quarter_ID=? AND p.productBarcode.product.brand.brand_ID IN " + brandIdSQL;
		String sql_purchase_total = "SELECT SUM(quantity), p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.year.year_ID=? AND p.productBarcode.product.quarter.quarter_ID=? AND p.productBarcode.product.brand.brand_ID NOT IN " + notCoundBrandId;

		if (chainId != Common_util.ALL_RECORD){
			sql2 += "AND p.order.client_id = ? ";
			sql_purchase_total += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null)
				value_purchase.add(chainStore.getClient_id());
			else 
				value_purchase.add(Common_util.ALL_RECORD);
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_purchase);
			if (chainSQL != null ){
			    sql2 += "AND " + chainSQL;
			    sql_purchase_total += "AND " + chainSQL;
			}
		}
		sql2 += " GROUP BY p.productBarcode.product.brand.brand_ID, p.order.order_type";
		sql_purchase_total += " GROUP BY p.order.order_type";
		List<Object> purchaseResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql2, value_purchase.toArray(), null, true);

		//@4. 生成采购总数
		List<Object> purchaseTotalResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql_purchase_total, value_purchase.toArray(), null, true);

		//@5. 生成库存数据
		String chainCriteria = "";
		ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
		if (chainId == Common_util.ALL_RECORD){
			chainCriteria = " c.clientId <> " + ChainStore.CLIENT_ID_TEST_ID;
		}else{
			chainCriteria = " c.clientId = " + chainStore.getClient_id();	
		}
		String sql_in_out = "SELECT c.productBarcode.product.brand.brand_ID, SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.product.year.year_ID=? AND c.productBarcode.product.quarter.quarter_ID=? AND c.productBarcode.product.brand.brand_ID IN " + brandIdSQL +" GROUP BY c.productBarcode.product.brand.brand_ID";

		List<Object> inventory = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out, value_inventory.toArray(),null,true);
		
		//@6. 生成库存总数
		String sql_in_out_total = "SELECT SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND  c.productBarcode.product.year.year_ID=?  AND c.productBarcode.product.quarter.quarter_ID=?  AND c.productBarcode.product.brand.brand_ID NOT IN" + notCoundBrandId;
		List<Object> inventory_total = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out_total, value_inventory.toArray(),null,true);
		
		setAllInOneLevelThreeItem(salesResult, purchaseResult, salesTotalResult, purchaseTotalResult, inventory, inventory_total, result, chainId, yearId, quarterId, startDate, endDate);
	}



	private  void generateAllInOneReportLevelFour(Date startDate,
			Date endDate, int chainId, int yearId, int quarterId, int brandId,
			Map<String, Object> result, Pager pager) {
		//@1. calculate the pager
		if (pager.getTotalResult() == 0){
			int totalBarcode = productBarcodeDaoImpl.getNumOfProductsUnderYQB(yearId, quarterId, brandId);
			pager.initialize(totalBarcode);
		} else {
			pager.calFirstResult();
		}
		
		//@1.1 组成sql parameters
		List<Object> value_sale = new ArrayList<Object>();
		value_sale.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale.add(startDate);
		value_sale.add(endDate);
		
		List<Object> value_purchase = new ArrayList<Object>();
		value_purchase.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_purchase.add(startDate);
		value_purchase.add(endDate);

        
		List<Object> value_sale_total = new ArrayList<Object>();
		value_sale_total.add(ChainStoreSalesOrder.STATUS_COMPLETE);
		value_sale_total.add(startDate);
		value_sale_total.add(endDate);
		value_sale_total.add(yearId);
		value_sale_total.add(quarterId);
		value_sale_total.add(brandId);
		
		List<Object> value_purchase_total = new ArrayList<Object>();
		value_purchase_total.add(InventoryOrder.STATUS_ACCOUNT_COMPLETE);
		value_purchase_total.add(startDate);
		value_purchase_total.add(endDate);
		value_purchase_total.add(yearId);
		value_purchase_total.add(quarterId);
		value_purchase_total.add(brandId);
		
        List<Object> value_inventory_total = new ArrayList<Object>();
        value_inventory_total.add(yearId);
        value_inventory_total.add(quarterId);
        value_inventory_total.add(brandId);
 
		//@2. 获取这页的brand ids
		List<Object> pbIds = productBarcodeDaoImpl.getProductsUnderYQB(yearId, quarterId,brandId, pager.getFirstResult(), pager.getRecordPerPage());
		String pbIdSQL = "(";
		if (pbIds.size() != 0)
			for (int i = 0; i < pbIds.size(); i++){
				Object pbId = pbIds.get(i);
				pbIdSQL += pbId;
				if (i == pbIds.size() -1)
					pbIdSQL += ")";
				else 
					pbIdSQL += ",";
			}
		else 
			pbIdSQL ="(0)";
		
		//@3. 生成销售数据
		String sql = "SELECT SUM(quantity), csp.productBarcode.id, csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.id IN " + pbIdSQL;
		String sql_sales_total = "SELECT SUM(quantity), csp.type  FROM ChainStoreSalesOrderProduct csp " + 
		         " WHERE csp.chainSalesOrder.status = ? AND csp.chainSalesOrder.orderDate BETWEEN ? AND ? AND csp.productBarcode.product.year.year_ID=? AND csp.productBarcode.product.quarter.quarter_ID=?  AND csp.productBarcode.product.brand.brand_ID =? ";

		if (chainId != Common_util.ALL_RECORD){
			sql += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id = ? ";
			value_sale.add(chainId);
			value_sale_total.add(chainId);
		} else { 
			sql += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			sql_sales_total += "AND csp.chainSalesOrder.chainStore.chain_id <> ? ";
			value_sale.add(ChainStore.CHAIN_ID_TEST_ID);
			value_sale_total.add(ChainStore.CHAIN_ID_TEST_ID);
		}
		sql += " GROUP BY csp.productBarcode.id, csp.type ";
		sql_sales_total += " GROUP BY csp.type ";
		
		List<Object> salesResult = chainSalesOrderDaoImpl.executeHQLSelect(sql, value_sale.toArray(), null, true);
		
		//@2. 生成销售总数
		List<Object> salesTotalResult = chainSalesOrderDaoImpl.executeHQLSelect(sql_sales_total, value_sale_total.toArray(), null, true);
		
		//@3. 生成采购数据
		String sql2 = "SELECT SUM(quantity), p.productBarcode.id, p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.id IN " + pbIdSQL;
		String sql_purchase_total = "SELECT SUM(quantity), p.order.order_type FROM InventoryOrderProduct p " + 
		         " WHERE p.order.order_Status = ? AND p.order.order_EndTime BETWEEN ? AND ? AND p.productBarcode.product.year.year_ID=? AND p.productBarcode.product.quarter.quarter_ID=?  AND p.productBarcode.product.brand.brand_ID =? ";

		if (chainId != Common_util.ALL_RECORD){
			sql2 += "AND p.order.client_id = ? ";
			sql_purchase_total += "AND p.order.client_id = ? ";
			ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
			
			if (chainStore != null){
				value_purchase.add(chainStore.getClient_id());
				value_purchase_total.add(chainStore.getClient_id());
			} else {
				value_purchase.add(Common_util.ALL_RECORD);
				value_purchase_total.add(Common_util.ALL_RECORD);
			}
		} else { 
			String chainSQL = constructChainSQL("p.order.client_id", value_purchase);
			if (chainSQL != null ){
			    sql2 += "AND " + chainSQL;
			    sql_purchase_total += "AND " + chainSQL;
			}
		}
		sql2 += " GROUP BY p.productBarcode.id, p.order.order_type";
		sql_purchase_total += " GROUP BY p.order.order_type";
		List<Object> purchaseResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql2, value_purchase.toArray(), null, true);

		//@4. 生成采购总数
		List<Object> purchaseTotalResult = inventoryOrderProductDAOImpl.executeHQLSelect(sql_purchase_total, value_purchase_total.toArray(), null, true);

		//@5. 生成库存数据
		String chainCriteria = "";
		ChainStore chainStore = chainStoreDaoImpl.get(chainId, true);
		if (chainId == Common_util.ALL_RECORD){
			chainCriteria = " c.clientId <> " + ChainStore.CLIENT_ID_TEST_ID;
		}else{
			chainCriteria = " c.clientId = " + chainStore.getClient_id();	
		}
		String sql_in_out = "SELECT c.productBarcode.id, SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND c.productBarcode.id IN " + pbIdSQL+" GROUP BY c.productBarcode.id";

		List<Object> inventory = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out, null,null,true);
		
		//@6. 生成库存总数
		String sql_in_out_total = "SELECT SUM(c.quantity) FROM ChainInOutStock c WHERE "+ chainCriteria +" AND  c.productBarcode.product.year.year_ID=?  AND c.productBarcode.product.quarter.quarter_ID=?  AND c.productBarcode.product.brand.brand_ID =? ";
		List<Object> inventory_total = chainInOutStockDaoImpl.executeHQLSelect(sql_in_out_total, value_inventory_total.toArray(),null,true);
		
		setAllInOneLevelFourItem(salesResult, purchaseResult, salesTotalResult, purchaseTotalResult, inventory, inventory_total, result, chainId, yearId, quarterId, brandId, startDate, endDate);	
	}

	private void setAllInOneLevelOneItem(List<Object> salesResult,
			List<Object> purchaseResult, List<Object> salesTotalResult,
			List<Object> purchaseTotalResult, List<Object> inventoryResult,
			List<Object> inventoryTotal, Map<String, Object> result, int chainId, Date startDate, Date endDate) {
		Map<Integer, ChainAllInOneReportItemLevelOne> dataMap = new HashMap<Integer, ChainAllInOneReportItemLevelOne>();
		ChainStore chainStore = this.getThisChainStore(chainId);
		
		if (salesResult != null){
			for (Object record : salesResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int yearId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelOne levelOneItem = dataMap.get(yearId);
				if (levelOneItem != null){
					levelOneItem.putSales(type, quantity);
				} else {
					Year year = yearDaoImpl.get(yearId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelOne(chainStore, startDate, endDate, year);
					
					levelOneItem.putSales(type, quantity);
					dataMap.put(yearId, levelOneItem);
				}
			}
		}
		
		if (purchaseResult != null){
			for (Object record : purchaseResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int yearId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelOne levelOneItem = dataMap.get(yearId);
				if (levelOneItem != null){
					levelOneItem.putPurchase(type, quantity);
				} else {
					Year year = yearDaoImpl.get(yearId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelOne(chainStore, startDate, endDate, year);
					
					levelOneItem.putPurchase(type, quantity);
					dataMap.put(yearId, levelOneItem);
				}
			}
		}
		
		if (inventoryResult != null){
			for (Object record : inventoryResult ){
				Object[] records = (Object[])record;
				int yearId = Common_util.getInt(records[0]);
				int quantity = Common_util.getInt(records[1]);
				
				ChainAllInOneReportItemLevelOne levelOneItem = dataMap.get(yearId);
				if (levelOneItem != null){
					levelOneItem.putInventory(quantity);
				} else {
					Year year = yearDaoImpl.get(yearId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelOne(chainStore, startDate, endDate, year);
					
					levelOneItem.putInventory(quantity);
					dataMap.put(yearId, levelOneItem);
				}
			}
		}
		
		ChainAllInOneReportItemLevelOne totalItem = new ChainAllInOneReportItemLevelOne(chainStore, startDate, endDate, null);
		if (salesTotalResult != null){
			for (Object record : salesTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putSales(type, quantity);
			}
		}
		
		if (purchaseTotalResult != null){
			for (Object record : purchaseTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putPurchase(type, quantity);
			}
		}
		
		if (inventoryTotal != null){
			for (Object record : inventoryTotal ){
				int quantity = Common_util.getInt(record);
				
				totalItem.putInventory(quantity);
			}
		}
		
		List<Integer> yearKey = new ArrayList<Integer>(dataMap.keySet());
		Collections.sort(yearKey);
		
		List<ChainAllInOneReportItemLevelOne> levelOneItems = new ArrayList<ChainAllInOneReportItemLevelOne>();
		for (Integer yearId: yearKey){
			levelOneItems.add(dataMap.get(yearId));
		}
		
		result.put("data", levelOneItems);
		result.put("total", totalItem);
		
	}
	
	private void setAllInOneLevelTwoItem(List<Object> salesResult,
			List<Object> purchaseResult, List<Object> salesTotalResult,
			List<Object> purchaseTotalResult, List<Object> inventory,
			List<Object> inventory_total, Map<String, Object> result,
			int chainId, int yearId, Date startDate, Date endDate) {
		Map<Integer, ChainAllInOneReportItemLevelTwo> dataMap = new HashMap<Integer, ChainAllInOneReportItemLevelTwo>();
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		
		if (salesResult != null){
			for (Object record : salesResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int quarterId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelTwo levelOneItem = dataMap.get(quarterId);
				if (levelOneItem != null){
					levelOneItem.putSales(type, quantity);
				} else {
					Quarter quarter = quarterDaoImpl.get(quarterId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelTwo(chainStore, startDate, endDate, year, quarter);
					
					levelOneItem.putSales(type, quantity);
					dataMap.put(quarterId, levelOneItem);
				}
			}
		}
		
		if (purchaseResult != null){
			for (Object record : purchaseResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int quarterId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelTwo levelOneItem = dataMap.get(quarterId);
				if (levelOneItem != null){
					levelOneItem.putPurchase(type, quantity);
				} else {
					Quarter quarter = quarterDaoImpl.get(quarterId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelTwo(chainStore, startDate, endDate, year, quarter);
					
					levelOneItem.putPurchase(type, quantity);
					dataMap.put(quarterId, levelOneItem);
				}
			}
		}
		
		if (inventory != null){
			for (Object record : inventory ){
				Object[] records = (Object[])record;
				int quarterId = Common_util.getInt(records[0]);
				int quantity = Common_util.getInt(records[1]);
				
				ChainAllInOneReportItemLevelTwo levelOneItem = dataMap.get(quarterId);
				if (levelOneItem != null){
					levelOneItem.putInventory(quantity);
				} else {
					Quarter quarter = quarterDaoImpl.get(quarterId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelTwo(chainStore, startDate, endDate, year, quarter);
					
					levelOneItem.putInventory(quantity);
					dataMap.put(quarterId, levelOneItem);
				}
			}
		}
		
		ChainAllInOneReportItemLevelTwo totalItem = new ChainAllInOneReportItemLevelTwo(chainStore, startDate, endDate, null, null);
		if (salesTotalResult != null){
			for (Object record : salesTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putSales(type, quantity);
			}
		}
		
		if (purchaseTotalResult != null){
			for (Object record : purchaseTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putPurchase(type, quantity);
			}
		}
		
		if (inventory_total != null){
			for (Object record : inventory_total ){
				int quantity = Common_util.getInt(record);
				
				totalItem.putInventory(quantity);
			}
		}
		
		List<Integer> quarterKey = new ArrayList<Integer>(dataMap.keySet());
		Collections.sort(quarterKey);
		
		List<ChainAllInOneReportItemLevelTwo> levelOneItems = new ArrayList<ChainAllInOneReportItemLevelTwo>();
		for (Integer quarterId: quarterKey){
			levelOneItems.add(dataMap.get(quarterId));
		}
		
		result.put("data", levelOneItems);
		result.put("total", totalItem);
		
	}

	
	private void setAllInOneLevelThreeItem(List<Object> salesResult,
			List<Object> purchaseResult, List<Object> salesTotalResult,
			List<Object> purchaseTotalResult, List<Object> inventory,
			List<Object> inventory_total, Map<String, Object> result,
			int chainId, int yearId, int quarterId, Date startDate, Date endDate) {
		Map<Integer, ChainAllInOneReportItemLevelThree> dataMap = new HashMap<Integer, ChainAllInOneReportItemLevelThree>();
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		
		if (salesResult != null){
			for (Object record : salesResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int brandId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelThree levelOneItem = dataMap.get(brandId);
				if (levelOneItem != null){
					levelOneItem.putSales(type, quantity);
				} else {
					Brand brand = brandDaoImpl.get(brandId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelThree(chainStore, startDate, endDate, year, quarter,brand);
					
					levelOneItem.putSales(type, quantity);
					dataMap.put(brandId, levelOneItem);
				}
			}
		}
		
		if (purchaseResult != null){
			for (Object record : purchaseResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int brandId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelThree levelOneItem = dataMap.get(brandId);
				if (levelOneItem != null){
					levelOneItem.putPurchase(type, quantity);
				} else {
					Brand brand = brandDaoImpl.get(brandId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelThree(chainStore, startDate, endDate, year, quarter,brand);
					
					levelOneItem.putPurchase(type, quantity);
					dataMap.put(brandId, levelOneItem);
				}
			}
		}
		
		if (inventory != null){
			for (Object record : inventory ){
				Object[] records = (Object[])record;
				int brandId = Common_util.getInt(records[0]);
				int quantity = Common_util.getInt(records[1]);
				
				ChainAllInOneReportItemLevelThree levelOneItem = dataMap.get(brandId);
				if (levelOneItem != null){
					levelOneItem.putInventory(quantity);
				} else {
					Brand brand = brandDaoImpl.get(brandId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelThree(chainStore, startDate, endDate, year, quarter,brand);
					
					levelOneItem.putInventory(quantity);
					dataMap.put(brandId, levelOneItem);
				}
			}
		}
		
		ChainAllInOneReportItemLevelThree totalItem = new ChainAllInOneReportItemLevelThree(chainStore, startDate, endDate, year, quarter, null);
		if (salesTotalResult != null){
			for (Object record : salesTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putSales(type, quantity);
			}
		}
		
		if (purchaseTotalResult != null){
			for (Object record : purchaseTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putPurchase(type, quantity);
			}
		}
		
		if (inventory_total != null){
			for (Object record : inventory_total ){
				int quantity = Common_util.getInt(record);
				
				totalItem.putInventory(quantity);
			}
		}
		
		List<Integer> brandKey = new ArrayList<Integer>(dataMap.keySet());
		Collections.sort(brandKey);
		
		List<ChainAllInOneReportItemLevelThree> levelOneItems = new ArrayList<ChainAllInOneReportItemLevelThree>();
		for (Integer brandId: brandKey){
			levelOneItems.add(dataMap.get(brandId));
		}
		
		result.put("data", levelOneItems);
		result.put("total", totalItem);
	}

	private void setAllInOneLevelFourItem(List<Object> salesResult,
			List<Object> purchaseResult, List<Object> salesTotalResult,
			List<Object> purchaseTotalResult, List<Object> inventory,
			List<Object> inventory_total, Map<String, Object> result,
			int chainId, int yearId, int quarterId, int brandId,
			Date startDate, Date endDate) {
		Map<Integer, ChainAllInOneReportItemLevelFour> dataMap = new HashMap<Integer, ChainAllInOneReportItemLevelFour>();
		ChainStore chainStore = this.getThisChainStore(chainId);
		Year year = yearDaoImpl.get(yearId, true);
		Quarter quarter = quarterDaoImpl.get(quarterId, true);
		Brand brand = brandDaoImpl.get(brandId, true);
		
		if (salesResult != null){
			for (Object record : salesResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int pbId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelFour levelOneItem = dataMap.get(pbId);
				if (levelOneItem != null){
					levelOneItem.putSales(type, quantity);
				} else {
					ProductBarcode pb = productBarcodeDaoImpl.get(pbId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelFour(chainStore, startDate, endDate, year, quarter,brand,pb);
					
					levelOneItem.putSales(type, quantity);
					dataMap.put(pbId, levelOneItem);
				}
			}
		}
		
		if (purchaseResult != null){
			for (Object record : purchaseResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int pbId = Common_util.getInt(records[1]);
				int type = Common_util.getInt(records[2]);
				
				ChainAllInOneReportItemLevelFour levelOneItem = dataMap.get(pbId);
				if (levelOneItem != null){
					levelOneItem.putPurchase(type, quantity);
				} else {
					ProductBarcode pb = productBarcodeDaoImpl.get(pbId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelFour(chainStore, startDate, endDate, year, quarter,brand,pb);
					
					levelOneItem.putPurchase(type, quantity);
					dataMap.put(pbId, levelOneItem);
				}
			}
		}
		
		if (inventory != null){
			for (Object record : inventory ){
				Object[] records = (Object[])record;
				int pbId = Common_util.getInt(records[0]);
				int quantity = Common_util.getInt(records[1]);
				
				ChainAllInOneReportItemLevelFour levelOneItem = dataMap.get(pbId);
				if (levelOneItem != null){
					levelOneItem.putInventory(quantity);
				} else {
					ProductBarcode pb = productBarcodeDaoImpl.get(pbId, true);
					
					levelOneItem = new ChainAllInOneReportItemLevelFour(chainStore, startDate, endDate, year, quarter,brand, pb);
					
					levelOneItem.putInventory(quantity);
					dataMap.put(pbId, levelOneItem);
				}
			}
		}
		
		ChainAllInOneReportItemLevelFour totalItem = new ChainAllInOneReportItemLevelFour(chainStore, startDate, endDate, year, quarter, brand, null);
		if (salesTotalResult != null){
			for (Object record : salesTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putSales(type, quantity);
			}
		}
		
		if (purchaseTotalResult != null){
			for (Object record : purchaseTotalResult ){
				Object[] records = (Object[])record;
				int quantity = Common_util.getInt(records[0]);
				int type = Common_util.getInt(records[1]);
				
				totalItem.putPurchase(type, quantity);
			}
		}
		
		if (inventory_total != null){
			for (Object record : inventory_total ){
				int quantity = Common_util.getInt(record);
				
				totalItem.putInventory(quantity);
			}
		}
		
		List<Integer> brandKey = new ArrayList<Integer>(dataMap.keySet());
		Collections.sort(brandKey);
		
		List<ChainAllInOneReportItemLevelFour> levelOneItems = new ArrayList<ChainAllInOneReportItemLevelFour>();
		for (Integer pbId: brandKey){
			levelOneItems.add(dataMap.get(pbId));
		}
		
		result.put("data", levelOneItems);
		result.put("total", totalItem);
		
	}

	/**
	 * 准备销售分析报表页面
	 * @param formBean
	 */
	public void prepareSalesAnalysisReportUI(ChainReportActionFormBean formBean) {
		formBean.setChainStore(chainStoreDaoImpl.getAllChainStoreObject());
		
	}

	/**
	 * 获取按照销售人员排名的销售报表
	 * @param formBean
	 * @param page
	 * @param rows
	 * @param sort
	 * @param order
	 * @return
	 */
	public Response generateSalesReportBySaler(
			ChainReportActionFormBean formBean, int page, int rows,
			String sort, String order, ChainUserInfor loginUser) {
		Response response = new Response();
		
		int chainId = formBean.getChainStore().getChain_id();
		Date startDate = Common_util.formStartDate(formBean.getStartDate());
		Date endDate = Common_util.formEndDate(formBean.getEndDate());
		
		ChainReport report = new ChainReport();
		report.setChainStore(formBean.getChainStore());
		
		Map saleReport = new HashMap<String, Object>();
		
		try {
			generateSalesReportBySaler(saleReport, chainId, startDate, endDate, page, rows, sort, order, loginUser);
			response.setReturnCode(Response.SUCCESS);
		} catch (Exception e) {
			response.setReturnCode(Response.FAIL);
		}
		response.setReturnValue(saleReport);
		
		return response;
	}

	private void generateSalesReportBySaler(Map saleReport, int chainId,
			Date startDate, Date endDate, Integer page, Integer rowPerPage, String sort,
			String order, ChainUserInfor loginUser) {
		/**
		 * 1. 获取total
		 */
		Object[] value_sale = new Object[]{startDate, endDate, ChainStoreSalesOrder.STATUS_COMPLETE};
		ChainSalesReport totalReport = generateSalesTotal(chainId, Common_util.ALL_RECORD, value_sale);
		if (!ChainUserInforService.isMgmtFromHQ(loginUser) && loginUser.getRoleType().getChainRoleTypeId() != ChainRoleType.CHAIN_OWNER){
			totalReport.setFreeCostSum(0);
			totalReport.setNetProfit(0);
			totalReport.setNetSaleCostSum(0);
		}
		
		/**
		 * 2. 实现分页,如果是搜索所有连锁店
		 */
		int total = 0;
		if (page != null && rowPerPage != null)
			total = calculateSaleReportBySalerCount(chainId, value_sale);
		
		/**
		 * 获取数据列表
		 */
		List<ChainSalesReport> reports = new ArrayList<ChainSalesReport>();
		String criteria = "";
		if (chainId == Common_util.ALL_RECORD)
			criteria = " FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ?";
		else 
			criteria = "FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ? AND chainStore.chain_id = " + chainId;

		criteria += " GROUP BY  saler.user_id ";
		
		String orderBy = generateSalesOrderBy(sort, order);
		
		criteria += orderBy;
		
		String hql_sale2 = "SELECT sum(totalQuantity), sum(netAmount), sum(totalQuantityR), " +
				"sum(netAmountR), sum(totalCost), sum(totalQuantityF) ,sum(totalCostF), sum(discountAmount), " +
				"sum(coupon), sum (cardAmount), sum(cashAmount - returnAmount), sum(vipScore), chainStore.chain_id, sum(totalAmount - netAmount),  saler.user_id, sum(qxQuantity), sum(qxAmount), sum(qxCost), sum(myQuantity), sum(myAmount), sum(myCost)  " + criteria;

		Integer[] pagerArray = null;
		if (page != null && rowPerPage != null)
		      pagerArray = new Integer[]{Common_util.getFirstRecord(page, rowPerPage), rowPerPage};
		
		List<Object> sales2 = (List<Object>)chainSalesOrderDaoImpl.executeHQLSelect(hql_sale2, value_sale,pagerArray, true);

		for (Object resultObject : sales2){
			Object[] sales3 = (Object[])resultObject;
			int totalQ2 = Common_util.getInt(sales3[0]);
			double netAmt2 = Common_util.getDouble(sales3[1]);
			int totalQR2 = Common_util.getInt(sales3[2]);
			double netAmtR2 = Common_util.getDouble(sales3[3]);
			double totalCost2 = Common_util.getDouble(sales3[4]);
			int totalQF2 = Common_util.getInt(sales3[5]);
			double totalCostF2 = Common_util.getDouble(sales3[6]);
			double discountAmt2 = Common_util.getDouble(sales3[7]);
			double coupon2 = Common_util.getDouble(sales3[8]);
			double cardAmt2 = Common_util.getDouble(sales3[9]);
			double cashAmt2 = Common_util.getDouble(sales3[10]);
			double vipScoreAmt2 = Common_util.getDouble(sales3[11]);
			int chainStoreId =  Common_util.getInt(sales3[12]);
			double totalSalesDiscountAmt2 = Common_util.getDouble(sales3[13]);
			int salerId = Common_util.getInt(sales3[14]);
			int qxQuantity = Common_util.getInt(sales3[15]);
			double qxAmount = Common_util.getDouble(sales3[16]);
			double qxCost = Common_util.getDouble(sales3[17]);
			int myQuantity = Common_util.getInt(sales3[18]);
			double myAmount = Common_util.getDouble(sales3[19]);
			double myCost = Common_util.getDouble(sales3[20]);		

			ChainStore store = chainStoreDaoImpl.get(chainStoreId, true);
			ChainUserInfor user = chainUserInforDaoImpl.get(salerId, true);
			
			ChainSalesReport chainReport2 = new ChainSalesReport(ChainReport.TYPE_SALES_REPORT, totalQ2, totalQR2,
					totalQF2, netAmt2,totalSalesDiscountAmt2, netAmtR2,totalCost2, totalCostF2, discountAmt2,
					coupon2, cardAmt2, cashAmt2, vipScoreAmt2, qxQuantity,qxAmount, qxCost, myQuantity, myAmount, myCost, store,user);
			
			if (!ChainUserInforService.isMgmtFromHQ(loginUser) && loginUser.getRoleType().getChainRoleTypeId() != ChainRoleType.CHAIN_OWNER){
				chainReport2.setFreeCostSum(0);
				chainReport2.setNetProfit(0);
				chainReport2.setNetSaleCostSum(0);
			}
			
			reports.add(chainReport2);
		}

		List<ChainSalesReport> footer = new ArrayList<ChainSalesReport>();
		footer.add(totalReport);
		saleReport.put("footer", footer);
		saleReport.put("rows", reports);
		saleReport.put("total", total);
		
	}

	private int calculateSaleReportBySalerCount(int chainId, Object[] value_sale) {
		//2.1 计算pager
		String criteria = "";
		if (chainId == Common_util.ALL_RECORD)
			criteria = " FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ?";
		else 
			criteria = "FROM ChainStoreSalesOrder WHERE orderDate BETWEEN ? AND ? AND status = ? AND chainStore.chain_id = " + chainId;

		String criteria2 = "SELECT COUNT(DISTINCT saler.user_id) " + criteria;
		    
	    return chainSalesOrderDaoImpl.executeHQLCount(criteria2, value_sale, true);
	}

	/**
	 * 获取
	 * @param chainStore
	 * @param startDate
	 * @param endDate
	 * @param year
	 * @param quarter
	 * @param brand
	 * @param loginUserInfor
	 * @param string
	 * @return
	 */
	public Response generateChainSalesStatisticExcelReport(
			ChainStore chainStore, ChainUserInfor saler, java.sql.Date startDate,
			java.sql.Date endDate, Year year, Quarter quarter, Brand brand,
			ChainUserInfor loginUserInfor, String filePath) {
		
            Response response = new Response();
            
            List<Object> result = new ArrayList<Object>();
            
    		int chainId = chainStore.getChain_id();
    		int salerId = saler.getUser_id();
    		int yearId = (year == null) ? 0 : year.getYear_ID();
    		int quarterId = (quarter == null) ? 0 : quarter.getQuarter_ID();
    		int brandId = (brand == null) ? 0 : brand.getBrand_ID();

            generateSalesStatisticReportLevelFour(startDate, endDate, chainId, salerId, yearId, quarterId, brandId, result, null);

			/**
			 * @2. 准备excel报表
			 */
			boolean showCost = false;
			if (ChainUserInforService.isMgmtFromHQ(loginUserInfor) || loginUserInfor.containFunction("purchaseAction!seeCost"))
				showCost = true;
			
			List<ChainSalesStatisReportItemLevelFour> reportItems = (List<ChainSalesStatisReportItemLevelFour>)result.get(0);
			Collections.sort(reportItems, new ChainSalesStatisticLevel4Comparator());
			
			ChainSalesStatisReportItemLevelFour totalItem = (ChainSalesStatisReportItemLevelFour)result.get(1);
			try {
				chainStore = this.getThisChainStore(chainStore.getChain_id());
				if (saler.getUser_id() != Common_util.ALL_RECORD)
					saler = chainUserInforDaoImpl.get(saler.getUser_id(), true);
				ChainSalesStatisticsReportTemplate chainSalesStatisticsReportTemplate = new ChainSalesStatisticsReportTemplate(reportItems,totalItem, chainStore, filePath, showCost, saler, startDate, endDate);
				HSSFWorkbook wb = chainSalesStatisticsReportTemplate.process();
				
				ByteArrayInputStream byteArrayInputStream = ExcelUtil.convertExcelToInputStream(wb);
				
				response.setReturnValue(byteArrayInputStream);
				response.setReturnCode(Response.SUCCESS);
			} catch (IOException e){
				response.setReturnCode(Response.FAIL);
			}
			return response;
	}

	class ChainSalesStatisticLevel4Comparator implements Comparator<ChainSalesStatisReportItemLevelFour> {

		@Override
		public int compare(ChainSalesStatisReportItemLevelFour o1,
				ChainSalesStatisReportItemLevelFour o2) {
			Product p1 = o1.getProductBarcode().getProduct();
			Product p2 = o2.getProductBarcode().getProduct();
			
			if (p1.getYear().getYear_ID() == p2.getYear().getYear_ID()){
				if (p1.getQuarter().getQuarter_ID() == p2.getQuarter().getQuarter_ID()){
					if (p1.getBrand().getBrand_ID() == p2.getBrand().getBrand_ID()){
						return p1.getProductCode().compareTo(p2.getProductCode());
					} else 
						return p1.getBrand().getBrand_ID() - p2.getBrand().getBrand_ID();
				} else 
					return p1.getQuarter().getQuarter_ID() - p2.getQuarter().getQuarter_ID();
			} else
			    return p1.getYear().getYear_ID() - p2.getYear().getYear_ID();
		}
	}



}
